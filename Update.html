// --- 修改配置與路徑 ---
const FIREBASE_CONFIG = { 
    apiKey: "AIzaSyAx2aYlfqHBUe3V7a3sT5ZPVNYyr2JY8OA", 
    authDomain: "av-roster-sync.firebaseapp.com", // 這裡也要同步
    projectId: "AV-Roster-Sync", // 關鍵修正
    storageBucket: "av-roster-sync.firebasestorage.app", 
    messagingSenderId: "70955835780", 
    appId: "1:70955835780:web:9d3b0958738557d1f7fdd1" 
};
const APP_ID = "AV-Roster-Sync"; // 路徑名稱同步

// --- 修改初始化邏輯 (統一旗標名稱) ---
useEffect(() => {
    const initProtocol = setInterval(() => {
        // 確保與 script module 裡的 window.isFirebaseReady 一致
        if (window.isFirebaseReady && window.Firebase) {
            clearInterval(initProtocol);
            try {
                const app = Firebase.getApps().length === 0 ? Firebase.initializeApp(FIREBASE_CONFIG) : Firebase.getApp();
                const auth = Firebase.getAuth(app);
                const firestore = Firebase.getFirestore(app);
                setDb(firestore);
                Firebase.signInAnonymously(auth).then(() => {
                    Firebase.onAuthStateChanged(auth, async (u) => { 
                        if(u) {
                            setUser(u); setStatus('idle');
                            // 修正路徑
                            const mapSnap = await Firebase.getDoc(Firebase.doc(firestore, 'artifacts', APP_ID, 'public', 'data', 'configs', 'name_mapping'));
                            if (mapSnap.exists()) setNameMapping(mapSnap.data().maps || {});
                        }
                    });
                });
            } catch (e) { setStatus('error'); console.error(e); }
        }
    }, 50); // 加快檢查速度
    return () => clearInterval(initProtocol);
}, []);
