<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Sync | Pro Publisher V3.2 (Refactored)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        window.Firebase = { initializeApp, getApps, getApp, getFirestore, doc, setDoc, getDoc, deleteDoc, getAuth, signInAnonymously, onAuthStateChanged };
        window.isFirebaseCoreLoaded = true; 
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --mac-blue: #0A84FF; --vip-color: #CEE6FF; --women-color: #FFCCFF; --men-color: #D1FFFF; --special-color: #FEFFD1; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background: #050505; color: #fff; min-height: 100vh; overflow: hidden; -webkit-font-smoothing: antialiased; }
        .aura-bg { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, #081021 0%, #050505 100%); z-index: -1; }
        
        /* Loading Animation */
        @keyframes rotate-orbit { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .racing-beam { position: absolute; inset: -6px; border-radius: 50%; background: conic-gradient(from 0deg, transparent 40%, #0A84FF 80%, #ffffff 100%); mask: radial-gradient(transparent 65%, black 67%); -webkit-mask: radial-gradient(transparent 65%, black 67%); filter: blur(1.2px); pointer-events: none; }
        .animate-orbit { animation: rotate-orbit 3s linear infinite; }
        
        .mac-glass { background: rgba(15, 15, 17, 0.95); backdrop-filter: blur(60px); border: 1px solid rgba(255,255,255,0.12); }
        .v3-name-block { @apply w-[56px] h-[56px] shrink-0 flex items-center justify-center rounded-[1.2rem] border font-black text-xl tracking-tighter shadow-lg; background: rgba(255,255,255,0.05); }
        .mapping-input { @apply bg-gray-700 w-[140px] h-[38px] text-center rounded-full px-4 text-lg font-black outline-none text-cyan-400 border-none shadow-xl transition-all focus:ring-4 focus:ring-cyan-400/20; }
        
        .mac-checkbox { width: 22px; height: 22px; border-radius: 6px; border: 2.5px solid rgba(255,255,255,0.2); margin-right: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .active .mac-checkbox { background: #60a5fa; border-color: #60a5fa; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        .page-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, memo, useCallback } = React;

        // --- Constants & Config ---
        const FIREBASE_CONFIG = { apiKey: "AIzaSyAx2aYlfqHBUe3V7a3sT5ZPVNYyr2JY8OA", authDomain: "tpac-schedule.firebaseapp.com", projectId: "tpac-schedule", storageBucket: "tpac-schedule.firebasestorage.app", messagingSenderId: "70955835780", appId: "1:70955835780:web:9d3b0958738557d1f7fdd1" };
        const APP_ID = "tpac-schedule";
        const STAFF_LIST = ["王志剛", "張國飛", "張劭如", "謝祥玄", "張懷德", "楊淯舒", "黎祐甄", "廖俊龍", "曾健洋", "劉智敏"];
        const STAFF_META = { 
            "廖俊龍": { type: "VIP", color: "#CEE6FF" }, "張劭如": { type: "F", color: "#FFCCFF" }, 
            "楊淯舒": { type: "F", color: "#FFCCFF" }, "黎祐甄": { type: "F", color: "#FFCCFF" }, 
            "劉智敏": { type: "Special", color: "#FEFFD1" }, "曾健洋": { type: "Special", color: "#FEFFD1" }, 
            "王志剛": { type: "M", color: "#D1FFFF" }, "張國飛": { type: "M", color: "#D1FFFF" }, 
            "張懷德": { type: "M", color: "#D1FFFF" }, "謝祥玄": { type: "M", color: "#D1FFFF" } 
        };
        const EXCEL_ROWS_START = [4, 52, 100, 148, 196, 244];
        const EXCEL_COLS_INDEX = [2, 5, 8, 11, 14, 17, 20];

        // --- Utility Functions ---
        const parseExcelDate = (cellValue) => {
            if (typeof cellValue === 'number') {
                const d = new Date(Math.round((cellValue - 25569) * 86400 * 1000));
                return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
            } else if (typeof cellValue === 'string') {
                const m = cellValue.match(/(\d{1,2})\/(\d{1,2})/);
                if (m) {
                    const now = new Date();
                    let year = now.getFullYear();
                    const month = parseInt(m[1]);
                    const day = parseInt(m[2]);
                    
                    // 動態年份修正邏輯：處理跨年問題
                    if (now.getMonth() >= 10 && month <= 2) year++; // 年底處理明年初班表
                    else if (now.getMonth() <= 1 && month >= 11) year--; // 年初讀取去年底資料
                    
                    return `${year}/${month.toString().padStart(2,'0')}/${day.toString().padStart(2,'0')}`;
                }
            }
            return null;
        };

        const processSheetData = (sheet, existingData) => {
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
            let { fR, fS, fH, fN } = existingData;

            EXCEL_ROWS_START.forEach(rS => {
                EXCEL_COLS_INDEX.forEach(cI => {
                    const dateKey = parseExcelDate(rows[rS]?.[cI]);
                    if (!dateKey) return;

                    if (!fR[dateKey]) fR[dateKey] = { GT:{}, BB:{}, GP:{} };
                    if (!fS[dateKey]) fS[dateKey] = {};

                    fH[dateKey] = { 
                        GT: (rows[rS-4]?.[cI] || "").toString().trim(), 
                        BB: (rows[rS-3]?.[cI] || "").toString().trim(), 
                        GP: (rows[rS-2]?.[cI] || "").toString().trim() 
                    };
                    fN[dateKey] = (rows[rS-1]?.[cI] || "").toString().trim();

                    for (let r = rS + 2; r <= rS + 30; r += 2) {
                        const name = (rows[r]?.[1] || "").trim();
                        if (!STAFF_LIST.includes(name)) continue;
                        
                        const code = (rows[r+1]?.[cI] || "").toString().trim();

                        if (code === "" || code.match(/休|例|休息|無排班|公假|婚假|喪假|病假|事假|特休|補休/)) {
                            fS[dateKey][name] = "休假";
                        } else if (code.match(/辦公|支援|居家|其他|其它/)) {
                            fS[dateKey][name] = "辦公";
                        } else {
                            const match = code.match(/(GT|BB|GP)-([A-F])/i);
                            if (match) {
                                const v = match[1].toUpperCase();
                                const s = ["A", "C", "E"].includes(match[2].toUpperCase()) ? "A" : "B";
                                fR[dateKey][v][name] = { shift: s };
                                fS[dateKey][name] = ""; 
                            } else {
                                fS[dateKey][name] = "辦公"; 
                            }
                        }
                    }
                });
            });
            return { fR, fS, fH, fN };
        };

        // --- Icons ---
        const Icon = memo(({ name, className = "w-4 h-4" }) => {
            const icons = {
                cloud: <path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.2-1.6-4-3.7-4.4-.5-3.1-3.2-5.6-6.3-5.6-2.5 0-4.7 1.5-5.7 3.6-2 .4-3.3 2.1-3.3 4.1C3 15.2 5.2 18 8 18h9.5z" />,
                copy: <path d="M8 4v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7.242a2 2 0 0 0-.602-1.43L16.083 2.57A2 2 0 0 0 14.685 2H10a2 2 0 0 0-2 2z M16 2v4h4 M4 8H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1"/>,
                check: <path d="M20 6 9 17l-5-5" />,
            };
            return <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        });

        // --- Sub Components ---
        const SuccessScreen = ({ report, onBack }) => (
            <div className="h-screen w-screen flex flex-col items-center bg-[#050505] p-6 page-fade-in text-center overflow-y-auto no-scrollbar relative z-50">
                <div className="aura-bg fixed inset-0"></div>
                <header className="w-full mt-10 mb-8 shrink-0"><h1 className="text-4xl font-black italic tracking-tighter uppercase leading-none">Uplink Success</h1></header>
                <main className="w-full max-w-lg flex-1 flex flex-col items-center justify-center">
                    <div className="mac-glass rounded-[4rem] p-10 flex flex-col items-center border-white/10 shadow-2xl w-full">
                        <div className="w-full bg-white/5 rounded-[3rem] p-8 border border-white/5 space-y-6 mb-8 shadow-inner">
                            <p className="text-[11px] font-black text-white/30 uppercase tracking-[0.3em]">雲端覆蓋跨度</p>
                            <p className="text-[#30D158] text-xl font-black">{report.start} ➔ {report.end}</p>
                            <div className="pt-6 border-t border-white/5 flex flex-wrap justify-center gap-2">
                                {report.sheets.map(s => <span key={s} className="bg-blue-600/30 text-blue-200 text-xs px-3 py-1 rounded-full border border-blue-500/20 font-black">{s}</span>)}
                            </div>
                            <div className="pt-6 border-t border-white/5"><p className="text-white text-base font-black">共注入 {report.total} 天班表</p></div>
                        </div>
                        <button onClick={onBack} className="w-full py-6 rounded-full bg-blue-600 font-black text-xs uppercase tracking-widest text-white shadow-xl hover:bg-blue-500 transition-colors">Back to Hub</button>
                    </div>
                </main>
            </div>
        );

        const AliasModal = ({ show, onClose, mapping, setMapping, onSave }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-[1000] flex items-center justify-center p-6 animate-in fade-in" onClick={onClose}>
                    <div className="absolute inset-0 bg-black/95 backdrop-blur-3xl"></div>
                    <div className="mac-glass w-[95%] max-w-5xl rounded-[3rem] p-8 flex flex-col shadow-2xl relative border-white/10 max-h-[90vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
                        <h3 className="text-3xl font-black italic uppercase text-center mb-8 text-white">Alias Management</h3>
                        <div className="flex-1 overflow-y-auto custom-scroll pr-2">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                {STAFF_LIST.map(name => {
                                    const meta = STAFF_META[name] || { type: 'M', color: '#fff' };
                                    return (
                                        <div key={name} className="flex items-center gap-4 p-2 bg-white/[0.02] border border-white/5 rounded-[1.8rem] h-18">
                                            <div className="v3-name-block" style={{ color: meta.color, borderColor: meta.color }}>{name[0]}</div>
                                            <div className="flex-1 flex items-center justify-between px-2">
                                                <span className="text-lg font-bold opacity-80 text-white">{name}</span>
                                                <input type="text" className="mapping-input" placeholder="Alias..." value={mapping[name] || ""} onChange={(e) => setMapping({...mapping, [name]: e.target.value})} />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <button onClick={onSave} className="mx-auto mt-6 px-12 py-4 bg-blue-600 rounded-full font-black text-xs uppercase tracking-widest shadow-xl text-white hover:bg-blue-500 transition-colors">Update Cloud Mapping</button>
                    </div>
                </div>
            );
        };

        const SheetPickerModal = ({ show, sheets, selected, setSelected, onConfirm, onWipe, onClose }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 z-[500] flex items-center justify-center p-6 animate-in fade-in" onClick={onClose}>
                    <div className="absolute inset-0 bg-black/95 backdrop-blur-3xl"></div>
                    <div className="mac-glass w-full max-w-sm rounded-[3.5rem] p-8 flex flex-col shadow-2xl relative overflow-hidden text-center text-white max-h-[85vh]" onClick={e=>e.stopPropagation()}>
                        <h3 className="text-xl font-black italic uppercase tracking-widest mb-6">Select Sheets</h3>
                        <div className="flex-1 overflow-y-auto custom-scroll pr-1 border-t border-b border-white/5 py-4">
                            {sheets.map(name => (
                                <div key={name} onClick={() => setSelected(p => p.includes(name)?p.filter(n=>n!==name):[...p, name])} className="h-14 flex items-center justify-center cursor-pointer transition-all hover:bg-white/5 rounded-2xl mb-1 select-none">
                                    <div className={`mac-checkbox ${selected.includes(name)?'active':''}`}>{selected.includes(name) && <Icon name="check" className="text-white w-3.5 h-3.5" />}</div>
                                    <span className={`text-xl font-black tracking-tighter ${selected.includes(name)?'text-blue-500':'text-white/20'}`}>{name}</span>
                                </div>
                            ))}
                        </div>
                        <button onClick={onConfirm} className="w-full py-5 rounded-full bg-blue-600 mt-8 font-black text-xs uppercase tracking-widest text-white shadow-lg disabled:opacity-50 hover:bg-blue-500 transition-colors" disabled={selected.length===0}>Push to Cloud</button>
                        <button onClick={onWipe} className="w-full mt-4 py-2 text-[10px] text-rose-500 font-black uppercase opacity-40 hover:opacity-100 transition-all">Wipe Cloud Data</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [status, setStatus] = useState('connecting'); 
            const [sheetNames, setSheetNames] = useState([]);
            const [selectedSheets, setSelectedSheets] = useState([]);
            const [wb, setWb] = useState(null);
            const [report, setReport] = useState(null);
            const [nameMapping, setNameMapping] = useState({});
            const [showAliasModal, setShowAliasModal] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const initProtocol = setInterval(() => {
                    if (window.isFirebaseCoreLoaded && window.Firebase) {
                        clearInterval(initProtocol);
                        try {
                            const app = Firebase.getApps().length === 0 ? Firebase.initializeApp(FIREBASE_CONFIG) : Firebase.getApp();
                            const auth = Firebase.getAuth(app);
                            const firestore = Firebase.getFirestore(app);
                            setDb(firestore);
                            Firebase.signInAnonymously(auth).then(() => {
                                Firebase.onAuthStateChanged(auth, async (u) => { 
                                    if(u) {
                                        setUser(u); setStatus('idle');
                                        const mapSnap = await Firebase.getDoc(Firebase.doc(firestore, 'artifacts', APP_ID, 'public', 'data', 'configs', 'name_mapping'));
                                        if (mapSnap.exists()) setNameMapping(mapSnap.data().maps || {});
                                    }
                                });
                            });
                        } catch (e) { setStatus('error'); console.error(e); }
                    }
                }, 150);
                return () => clearInterval(initProtocol);
            }, []);

            const onFileChange = useCallback((e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                        setWb(workbook);
                        setSheetNames(workbook.SheetNames.filter(n => !n.includes("設定") && !n.includes("準則")));
                        setStatus('picking');
                    } catch (err) { alert("Excel 讀取失敗，請確認格式"); }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = null;
            }, []);

            // Sync Logic (修正版：同步前自動清空舊資料)
            const runSync = async () => {
                if (!selectedSheets.length || !db) return;
                setStatus('syncing');
                await new Promise(r => setTimeout(r, 100));

                try {
                    const docRef = Firebase.doc(db, 'artifacts', APP_ID, 'public', 'data', 'rosters', 'master');
                    
                    // --- 修改處：不再讀取雲端舊資料，直接從空物件開始 ---
                    // 這樣上傳後，雲端只會留下本次 Excel 提到的日期
                    let existingData = { fR: {}, fS: {}, fH: {}, fN: {} };
                    
                    // (移除原本讀取 snap.exists() 的邏輯)

                    // Process Data using Utility
                    selectedSheets.forEach(name => {
                        existingData = processSheetData(wb.Sheets[name], existingData);
                    });

                    const { fR, fS, fH, fN } = existingData;
                    const allK = Object.keys(fR).sort();
                    if (allK.length === 0) throw new Error("無有效排班資料被提取");

                    // 直接使用 setDoc 覆蓋雲端檔案
                    await Firebase.setDoc(docRef, { 
                        roster: JSON.stringify(fR), 
                        statuses: JSON.stringify(fS), 
                        shows: JSON.stringify(fH), 
                        notes: JSON.stringify(fN), 
                        lastUpdated: new Date().toISOString() 
                    });
                    
                    setReport({ total: allK.length, start: allK[0], end: allK[allK.length-1], sheets: selectedSheets });
                    setStatus('success');
                } catch (e) { 
                    alert("同步失敗: " + e.message); 
                    setStatus('idle'); 
                }
            };

            const saveMapping = async () => {
                try {
                    await Firebase.setDoc(Firebase.doc(db, 'artifacts', APP_ID, 'public', 'data', 'configs', 'name_mapping'), { maps: nameMapping, updatedAt: new Date().toISOString() });
                    setShowAliasModal(false); alert("馬甲更新完成");
                } catch (e) { alert("儲存失敗"); }
            };

            const wipeData = async () => {
                if(confirm("⚠️ 確定清空雲端所有排班資料？")) { 
                    await Firebase.deleteDoc(Firebase.doc(db, 'artifacts', APP_ID, 'public', 'data', 'rosters', 'master')); 
                    alert("雲端已清空"); 
                    setStatus('idle'); 
                }
            };

            if (status === 'success' && report) return <SuccessScreen report={report} onBack={() => setStatus('idle')} />;

            return (
                <div className="h-screen w-screen bg-[#050505] text-white flex flex-col items-center justify-between p-10 relative overflow-hidden select-none">
                    <div className="aura-bg"></div>
                    <header className="w-full flex justify-between items-start z-40">
                        <button onClick={() => setShowAliasModal(true)} className="p-3 bg-white/5 border border-white/10 rounded-2xl active:scale-95 transition-all hover:bg-white/10"><Icon name="copy" className="text-blue-400 w-5 h-5" /></button>
                        <div className="text-center">
                            <h1 className="text-4xl font-black italic tracking-tighter uppercase leading-none">Cloud Sync</h1>
                            <div className={`mt-4 px-4 py-1 rounded-full border text-[9px] font-black uppercase inline-flex items-center gap-2 ${user?'border-emerald-500/30 text-emerald-500':'border-blue-500/30 text-blue-500'}`}>
                                <span className={`w-1.5 h-1.5 rounded-full ${user?'bg-emerald-500 shadow-[0_0_10px_#30D158]':'bg-blue-500 animate-pulse'}`}></span>
                                {user?'LINK READY':'CONNECTING...'}
                            </div>
                        </div>
                        <div className="w-12 h-12"></div>
                    </header>
                    <main className="flex-1 flex flex-col items-center justify-center relative w-full z-10">
                        <div onClick={() => status === 'idle' && fileInputRef.current.click()} className={`relative w-64 h-64 flex items-center justify-center transition-transform ${status === 'idle' ? 'cursor-pointer active:scale-95 hover:scale-105' : ''}`}>
                            <div className="absolute inset-0 rounded-full border-4 border-white/5"></div>
                            <div className={`racing-beam ${status === 'idle' || status === 'syncing' ? 'animate-orbit' : 'hidden'}`}></div>
                            <div className="w-48 h-48 rounded-full flex items-center justify-center bg-white/5 border border-white/10 shadow-inner backdrop-blur-sm z-10">
                                {status === 'syncing' || status === 'connecting' ? 
                                    <div className="w-16 h-16 border-[5px] border-white/10 border-t-blue-500 rounded-full animate-spin"></div> : 
                                    <Icon name="cloud" className="w-32 h-32 text-[#CEE6FF] drop-shadow-[0_0_20px_rgba(10,132,255,0.4)]" />
                                }
                            </div>
                        </div>
                        <p className="mt-12 text-[10px] font-black uppercase tracking-[0.6em] opacity-30 text-center select-none">Click core to upload</p>
                    </main>
                    <AliasModal show={showAliasModal} onClose={() => setShowAliasModal(false)} mapping={nameMapping} setMapping={setNameMapping} onSave={saveMapping} />
                    <SheetPickerModal show={status === 'picking'} sheets={sheetNames} selected={selectedSheets} setSelected={setSelectedSheets} onConfirm={runSync} onWipe={wipeData} onClose={() => setStatus('idle')} />
                    <footer className="w-full shrink-0 text-center opacity-30 mt-6 font-black tracking-widest text-[8px] text-white">© 2026 Stable Sync Architecture</footer>
                    <input type="file" ref={fileInputRef} className="hidden" onChange={onFileChange} accept=".xlsx" />
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
