<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Sync | Pro Publisher V3.1 (Logic Aligned)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        window.Firebase = { initializeApp, getApps, getApp, getFirestore, doc, setDoc, getDoc, deleteDoc, getAuth, signInAnonymously, onAuthStateChanged };
        window.isFirebaseCoreLoaded = true; 
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --mac-blue: #0A84FF; --vip-color: #CEE6FF; --women-color: #FFCCFF; --men-color: #D1FFFF; --special-color: #FEFFD1; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background: #050505; color: #fff; min-height: 100vh; overflow: hidden; -webkit-font-smoothing: antialiased; }
        .aura-bg { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, #081021 0%, #050505 100%); z-index: -1; }
        
        @keyframes rotate-orbit { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .orbit-container { position: relative; width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .racing-beam { position: absolute; inset: -6px; border-radius: 50%; background: conic-gradient(from 0deg, transparent 40%, #0A84FF 80%, #ffffff 100%); mask: radial-gradient(transparent 65%, black 67%); -webkit-mask: radial-gradient(transparent 65%, black 67%); animation: rotate-orbit 3s linear infinite; filter: blur(1.2px); pointer-events: none; }
        
        .mac-glass { background: rgba(15, 15, 17, 0.95); backdrop-filter: blur(60px); border: 1px solid rgba(255,255,255,0.12); }
        .v3-name-block { @apply w-[64px] h-[64px] shrink-0 flex items-center justify-center rounded-[1.2rem] border font-black text-2xl tracking-tighter shadow-lg; background: rgba(255,255,255,0.05); }
        .v3-name-block.VIP { border-color: var(--vip-color); color: var(--vip-color); background: rgba(206, 230, 255, 0.1); }
        .v3-name-block.F { border-color: var(--women-color); color: var(--women-color); background: rgba(255, 204, 255, 0.1); }
        .v3-name-block.M { border-color: var(--men-color); color: var(--men-color); background: rgba(209, 255, 255, 0.1); }
        .v3-name-block.Special { border-color: var(--special-color); color: var(--special-color); background: rgba(254, 255, 209, 0.1); }
        
        .mapping-input { 
            background-color: #4b5563 !important; 
            width: 140px !important; 
            height: 38px; 
            text-align: center !important;
            @apply rounded-full px-4 text-lg font-black outline-none text-cyan-400 border-none shadow-xl transition-all; 
        }
        .mapping-input:focus { @apply ring-4 ring-cyan-400/20; }
        
        .mac-checkbox { width: 22px; height: 22px; border-radius: 6px; border: 2.5px solid rgba(255,255,255,0.2); margin-right: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .active .mac-checkbox { background: #60a5fa; border-color: #60a5fa; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .page-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const Icon = ({ name, className = "w-4 h-4" }) => {
            const icons = {
                star: <path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>,
                cloud: <path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.2-1.6-4-3.7-4.4-.5-3.1-3.2-5.6-6.3-5.6-2.5 0-4.7 1.5-5.7 3.6-2 .4-3.3 2.1-3.3 4.1C3 15.2 5.2 18 8 18h9.5z" />,
                copy: <path d="M8 4v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7.242a2 2 0 0 0-.602-1.43L16.083 2.57A2 2 0 0 0 14.685 2H10a2 2 0 0 0-2 2z M16 2v4h4 M4 8H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1"/>,
                check: <path d="M20 6 9 17l-5-5" />, trash: <path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2m-6 11v-6m4 6v-6" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        const App = () => {
            const STAFF_LIST = ["王志剛", "張國飛", "張劭如", "謝祥玄", "張懷德", "楊淯舒", "黎祐甄", "廖俊龍", "曾健洋", "劉智敏"];
            const STAFF_META = { "廖俊龍": { type: "VIP" }, "張劭如": { type: "F" }, "楊淯舒": { type: "F" }, "黎祐甄": { type: "F" }, "劉智敏": { type: "Special" }, "曾健洋": { type: "Special" }, "王志剛": { type: "M" }, "張國飛": { type: "M" }, "張懷德": { type: "M" }, "謝祥玄": { type: "M" } };
            
            const FIREBASE_CONFIG = { apiKey: "AIzaSyAx2aYlfqHBUe3V7a3sT5ZPVNYyr2JY8OA", authDomain: "tpac-schedule.firebaseapp.com", projectId: "tpac-schedule", storageBucket: "tpac-schedule.firebasestorage.app", messagingSenderId: "70955835780", appId: "1:70955835780:web:9d3b0958738557d1f7fdd1" };
            const APP_ID = "tpac-schedule";

            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [status, setStatus] = useState('connecting'); 
            const [sheetNames, setSheetNames] = useState([]);
            const [selectedSheets, setSelectedSheets] = useState([]);
            const [wb, setWb] = useState(null);
            const [report, setReport] = useState(null);
            const [nameMapping, setNameMapping] = useState({});
            const [showAliasModal, setShowAliasModal] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const initProtocol = setInterval(() => {
                    if (window.isFirebaseCoreLoaded && window.Firebase) {
                        clearInterval(initProtocol);
                        const app = Firebase.getApps().length === 0 ? Firebase.initializeApp(FIREBASE_CONFIG) : Firebase.getApp();
                        const auth = Firebase.getAuth(app);
                        const firestore = Firebase.getFirestore(app);
                        setDb(firestore);
                        Firebase.signInAnonymously(auth).then(() => {
                            Firebase.onAuthStateChanged(auth, async (u) => { 
                                if(u) {
                                    setUser(u); setStatus('idle');
                                    const mapSnap = await Firebase.getDoc(Firebase.doc(firestore, 'artifacts', APP_ID, 'public', 'data', 'configs', 'name_mapping'));
                                    if (mapSnap.exists()) setNameMapping(mapSnap.data().maps || {});
                                }
                            });
                        }).catch(() => setStatus('error'));
                    }
                }, 150);
                return () => clearInterval(initProtocol);
            }, []);

            const onFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                        setWb(workbook);
                        setSheetNames(workbook.SheetNames.filter(n => !n.includes("設定") && !n.includes("準則")));
                        setStatus('picking');
                    } catch (err) { alert("Excel 讀取失敗，請確認格式"); }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = null;
            };

            const runSync = async () => {
                if (!selectedSheets.length) return;
                if (!db || !user) { alert("雲端授權連線中，請稍候再按。"); return; }
                
                setStatus('syncing');

                requestAnimationFrame(() => {
                    setTimeout(async () => {
                        try {
                            const docRef = Firebase.doc(db, 'artifacts', APP_ID, 'public', 'data', 'rosters', 'master');
                            const snap = await Firebase.getDoc(docRef);
                            let fR = {}, fS = {}, fH = {}, fN = {};
                            if (snap.exists()) {
                                const d = snap.data();
                                fR = JSON.parse(d.roster || '{}'); fS = JSON.parse(d.statuses || '{}');
                                fH = JSON.parse(d.shows || '{}'); fN = JSON.parse(d.notes || '{}');
                            }

                            selectedSheets.forEach(name => {
                                const rows = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1, defval: "" });
                                [4, 52, 100, 148, 196, 244].forEach(rS => {
                                    [2, 5, 8, 11, 14, 17, 20].forEach(cI => {
                                        let cell = rows[rS]?.[cI], dateKey = "";
                                        if (typeof cell === 'number') {
                                            const d = new Date(Math.round((cell - 25569) * 86400 * 1000));
                                            dateKey = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
                                        } else if (cell) {
                                            const m = cell.toString().match(/(\d{1,2})\/(\d{1,2})/);
                                            if (m) dateKey = `${parseInt(m[1]) >= 11 ? 2025 : 2026}/${m[1].padStart(2,'0')}/${m[2].padStart(2,'0')}`;
                                        }
                                        if (!dateKey) return;
                                        fR[dateKey] = { GT:{}, BB:{}, GP:{} }; fS[dateKey] = {};
                                        fH[dateKey] = { GT: (rows[rS-4]?.[cI] || "").toString().trim(), BB: (rows[rS-3]?.[cI] || "").toString().trim(), GP: (rows[rS-2]?.[cI] || "").toString().trim() };
                                        fN[dateKey] = (rows[rS-1]?.[cI] || "").toString().trim();
                                        for (let r = rS + 2; r <= rS + 30; r += 2) {
                                            const n = (rows[r]?.[1] || "").trim(); if (!STAFF_LIST.includes(n)) continue;
                                            const code = (rows[r+1]?.[cI] || "").toString().trim();
                                            
                                            // --- 同步 V4.1 邏輯核心開始 ---
                                            // 1. 判斷休假 (包含空值與多樣化假別)
                                            if (code === "" || code.match(/休|例|休息|無排班|公假|婚假|喪假|病假|事假|特休|補休/)) {
                                                fS[dateKey][n] = "休假";
                                            } 
                                            // 2. 判斷辦公 (包含其他/其它)
                                            else if (code.match(/辦公|支援|居家|其他|其它/)) {
                                                fS[dateKey][n] = "辦公";
                                            } 
                                            // 3. 判斷值班格式 (GT/BB/GP)
                                            else {
                                                const match = code.match(/(GT|BB|GP)-([A-F])/i);
                                                if (match) {
                                                    const v = match[1].toUpperCase();
                                                    const s = ["A", "C", "E"].includes(match[2].toUpperCase()) ? "A" : "B";
                                                    fR[dateKey][v][n] = { shift: s };
                                                    fS[dateKey][n] = ""; 
                                                } else {
                                                    // 4. 不符格式則預設為辦公 (避免資料遺失)
                                                    fS[dateKey][n] = "辦公";
                                                }
                                            }
                                            // --- 同步 V4.1 邏輯核心結束 ---
                                        }
                                    });
                                });
                            });

                            await Firebase.setDoc(docRef, { roster: JSON.stringify(fR), statuses: JSON.stringify(fS), shows: JSON.stringify(fH), notes: JSON.stringify(fN), lastUpdated: new Date().toISOString() });
                            const allK = Object.keys(fR).sort();
                            setReport({ total: allK.length, start: allK[0], end: allK[allK.length-1], sheets: selectedSheets });
                            setStatus('success');
                        } catch (e) { alert("同步失敗: " + e.message); setStatus('idle'); }
                    }, 100);
                });
            };

            const saveMapping = async () => {
                try {
                    await Firebase.setDoc(Firebase.doc(db, 'artifacts', APP_ID, 'public', 'data', 'configs', 'name_mapping'), { maps: nameMapping, updatedAt: new Date().toISOString() });
                    setShowAliasModal(false); alert("馬甲更新完成");
                } catch (e) { alert("儲存失敗"); }
            };

            if (status === 'success' && report) {
                return (
                    <div className="h-screen w-screen flex flex-col items-center bg-[#050505] p-6 page-fade-in text-center overflow-y-auto no-scrollbar">
                        <div className="aura-bg fixed inset-0"></div>
                        <header className="w-full mt-10 mb-8 shrink-0"><h1 className="text-4xl font-black italic tracking-tighter uppercase leading-none">Uplink Success</h1></header>
                        <main className="w-full max-w-lg flex-1 flex flex-col items-center justify-center">
                            <div className="mac-glass rounded-[4rem] p-10 flex flex-col items-center border-white/10 shadow-2xl w-full">
                                <div className="w-full bg-white/5 rounded-[3rem] p-8 border border-white/5 space-y-6 mb-8 shadow-inner">
                                    <p className="text-[11px] font-black text-white/30 uppercase tracking-[0.3em]">雲端覆蓋跨度</p>
                                    <p className="text-[#30D158] text-xl font-black">{report.start} ➔ {report.end}</p>
                                    <div className="pt-6 border-t border-white/5 flex flex-wrap justify-center gap-2">
                                        {report.sheets.map(s => <span key={s} className="bg-blue-600/30 text-blue-200 text-xs px-3 py-1 rounded-full border border-blue-500/20 font-black">{s}</span>)}
                                    </div>
                                    <div className="pt-6 border-t border-white/5"><p className="text-white text-base font-black">共注入 {report.total} 天班表</p></div>
                                </div>
                                <button onClick={() => setStatus('idle')} className="w-full py-6 rounded-full bg-blue-600 font-black text-xs uppercase tracking-widest text-white shadow-xl">Back to Hub</button>
                            </div>
                        </main>
                    </div>
                );
            }

            return (
                <div className="h-screen w-screen bg-[#050505] text-white flex flex-col items-center justify-between p-10 relative overflow-hidden select-none">
                    <div className="aura-bg fixed inset-0 bg-[radial-gradient(circle_at_50%_50%,#081021_0%,#050505_100%)] z-[-1]"></div>
                    <header className="w-full flex justify-between items-start z-50">
                        <button onClick={() => setShowAliasModal(true)} className="p-3 bg-white/5 border border-white/10 rounded-2xl active:scale-95 transition-all"><Icon name="copy" className="text-blue-400 w-5 h-5" /></button>
                        <div className="text-center">
                            <h1 className="text-4xl font-black italic tracking-tighter uppercase leading-none">Cloud Sync</h1>
                            <div className={`mt-4 px-4 py-1 rounded-full border text-[9px] font-black uppercase inline-flex items-center gap-2 ${user?'border-emerald-500/30 text-emerald-500':'border-blue-500/30 text-blue-500'}`}>
                                <span className={`w-1.5 h-1.5 rounded-full ${user?'bg-emerald-500 shadow-[0_0_10px_#30D158]':'bg-blue-500 animate-pulse'}`}></span>
                                {user?'LINK READY':'CONNECTING...'}
                            </div>
                        </div>
                        <div className="w-12 h-12"></div>
                    </header>

                    <main className="flex-1 flex flex-col items-center justify-center relative w-full z-10">
                        <div onClick={() => status === 'idle' && fileInputRef.current.click()} className="relative w-64 h-64 flex items-center justify-center cursor-pointer active:scale-95 transition-transform">
                            <div className="absolute inset-0 rounded-full border-4 border-white/5"></div>
                            <div className={`racing-beam ${status === 'idle' ? 'animate-[spin_4s_linear_infinite]' : ''}`}></div>
                            <div className="w-48 h-48 rounded-full flex items-center justify-center bg-white/5 border border-white/10 shadow-inner">
                                {status === 'syncing' || status === 'connecting' ? <div className="w-16 h-16 border-[5px] border-white/10 border-t-blue-500 rounded-full animate-spin"></div> : <Icon name="cloud" className="w-32 h-32 text-[#CEE6FF] drop-shadow-[0_0_20px_rgba(10,132,255,0.4)]" />}
                            </div>
                        </div>
                        <p className="mt-12 text-[10px] font-black uppercase tracking-[0.6em] opacity-30 text-center">Click core to upload</p>
                    </main>

                    {showAliasModal && (
                        <div className="fixed inset-0 z-[1000] flex items-center justify-center p-6 animate-in fade-in">
                            <div className="absolute inset-0 bg-black/95 backdrop-blur-3xl" onClick={() => setShowAliasModal(false)}></div>
                            <div className="mac-glass w-[95%] max-w-6xl rounded-[4.5rem] p-10 flex flex-col shadow-2xl relative border-white/10 max-h-[92vh] overflow-hidden">
                                <h3 className="text-3xl font-black italic uppercase text-center mb-8 text-white">Alias Management</h3>
                                <div className="flex-1 overflow-y-auto custom-scroll pr-2">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {STAFF_LIST.map(name => {
                                            const meta = STAFF_META[name] || { type: 'M' };
                                            let color = meta.type==='VIP'?'#CEE6FF':meta.type==='F'?'#FFCCFF':meta.type==='Special'?'#FEFFD1':'#D1FFFF';
                                            return (
                                                <div key={name} className="flex items-center gap-4 p-3 bg-white/[0.02] border border-white/5 rounded-[2.2rem] h-20">
                                                    <div className={`v3-name-block ${meta.type}`} style={{ color: color, borderColor: color }}>{name[0]}</div>
                                                    <div className="flex-1 flex items-center justify-between px-4">
                                                        <span className="text-xl font-bold opacity-80 text-white">{name}</span>
                                                        <input type="text" className="mapping-input" placeholder="..." value={nameMapping[name] || ""} onChange={(e) => setNameMapping({...nameMapping, [name]: e.target.value})} />
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <button onClick={saveMapping} className="mx-auto mt-8 px-12 py-4 bg-blue-600 rounded-full font-black text-xs uppercase tracking-widest shadow-xl text-white">Update Cloud Mapping</button>
                            </div>
                        </div>
                    )}

                    {status === 'picking' && (
                        <div className="fixed inset-0 z-[500] flex items-center justify-center p-6 animate-in fade-in">
                            <div className="absolute inset-0 bg-black/95 backdrop-blur-3xl" onClick={() => setStatus('idle')}></div>
                            <div className="mac-glass w-full max-w-sm rounded-[3.5rem] p-10 flex flex-col shadow-2xl relative overflow-hidden text-center text-white max-h-[85vh]">
                                <h3 className="text-xl font-black italic uppercase tracking-widest mb-6">Select Sheets</h3>
                                <div className="flex-1 overflow-y-auto custom-scroll pr-1 border-t border-b border-white/5 py-4">
                                    {sheetNames.map(name => (
                                        <div key={name} onClick={() => setSelectedSheets(p => p.includes(name)?p.filter(n=>n!==name):[...p, name])} className="h-14 flex items-center justify-center cursor-pointer transition-all hover:bg-white/5 rounded-2xl mb-1">
                                            <div className={`mac-checkbox ${selectedSheets.includes(name)?'active':''}`}>{selectedSheets.includes(name) && <Icon name="check" className="text-white w-3.5 h-3.5" />}</div>
                                            <span className={`text-xl font-black tracking-tighter ${selectedSheets.includes(name)?'text-blue-500':'text-white/20'}`}>{name}</span>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={runSync} className="w-full py-5 rounded-full bg-blue-600 mt-8 font-black text-xs uppercase tracking-widest text-white shadow-lg" disabled={selectedSheets.length===0}>Push to Cloud</button>
                                <button onClick={async () => { if(confirm("⚠️ 清空雲端所有排班資料？")) { await Firebase.deleteDoc(Firebase.doc(db, 'artifacts', APP_ID, 'public', 'data', 'rosters', 'master')); alert("雲端已清空"); setStatus('idle'); } }} className="w-full mt-4 py-2 text-[10px] text-rose-500 font-black uppercase opacity-40 hover:opacity-100 transition-all">Wipe Cloud Data</button>
                            </div>
                        </div>
                    )}
                    <footer className="w-full shrink-0 text-center opacity-30 mt-6 font-black tracking-widest text-[8px] text-white">© 2025 Stable Sync Architecture</footer>
                    <input type="file" ref={fileInputRef} className="hidden" onChange={onFileChange} accept=".xlsx" />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>