<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>視聽班表系統 | V6.2 Pro Visuals</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.Firebase = { initializeApp, getApps, getApp, getFirestore, doc, onSnapshot, getDoc, getAuth, signInAnonymously, onAuthStateChanged };
        window.isFirebaseReady = true;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { 
            --mac-bg: #000000; --mac-card: #121214; --mac-blue: #0A84FF; 
            --women-text: #FFD6E0; --men-text: #E0F7FF; --special-text: #FFFFE0;
            --women-dot: #FF375F; --men-dot: #00FFFF; --special-dot: #FFD60A;
            --master-gt: #8B0000; 
            --master-bb: #0A84FF; /* 對齊 BB 標題藍 */
            --master-gp: #006400; 
        }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; height: 100vh; overflow: hidden; background: #000000; color: #FFFFFF; -webkit-font-smoothing: antialiased; }
        .aura-bg { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, #0a183d 0%, #000000 100%); z-index: 0; pointer-events: none; }
        .aura-orb { position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, rgba(10, 132, 255, 0.08) 0%, transparent 70%); filter: blur(60px); animation: orb-move 20s infinite alternate ease-in-out; }
        @keyframes orb-move { 0% { transform: translate(-10%, -10%); } 100% { transform: translate(10%, 10%); } }
        .mac-glass { background: rgba(18, 18, 20, 0.85); backdrop-filter: blur(40px) saturate(200%); border-bottom: 0.5px solid rgba(255,255,255,0.12); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 啟動動畫樣式 */
        .unlock-glow-container { position: relative; width: 340px; height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 60; }
        .core-pulse { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { transform: scale(0.95); opacity: 0.5; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(0.95); opacity: 0.5; } }

        .vip-1-breath { animation: vip1-pulse 1.8s infinite alternate ease-in-out; font-weight: 900 !important; }
        @keyframes vip1-pulse { 0% { text-shadow: 0 0 4px rgba(255,255,255,0.2); } 100% { text-shadow: 0 0 8px #fff, 0 0 15px var(--mac-blue), 0 0 25px var(--mac-blue); } }

        .vip2-orbit-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .orbit-base { position: absolute; width: 125px; height: 42px; border-radius: 50%; animation: rotate-linear 4s linear infinite; z-index: 1; pointer-events: none; border: 1px solid rgba(255,255,255,0.08); }
        .orbit-base::after { content: ''; position: absolute; width: 8px; height: 8px; border-radius: 50%; left: 50%; bottom: -4px; transform: translateX(-50%); background: currentColor; box-shadow: 0 0 15px currentColor; }
        @keyframes rotate-linear { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .b-shift-glow { animation: b-glow-focus 1.5s infinite alternate; border: 1.5px solid #FFFFFF !important; }
        @keyframes b-glow-focus { 0% { box-shadow: 0 0 2px rgba(255,255,255,0.4); } 100% { box-shadow: 0 0 12px rgba(255,255,255,1); } }
        
        .master-sticky-col { position: sticky; left: 0; z-index: 30; background: #121214; min-width: 95px; border-right: 1.5px solid rgba(255,255,255,0.15); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, memo, useCallback } = React;

        const FIREBASE_CONFIG = { apiKey: "AIzaSyAx2aYlfqHBUe3V7a3sT5ZPVNYyr2JY8OA", authDomain: "tpac-schedule.firebaseapp.com", projectId: "tpac-schedule", storageBucket: "tpac-schedule.firebasestorage.app", messagingSenderId: "70955835780", appId: "1:70955835780:web:9d3b0958738557d1f7fdd1" };
        const STAFF_ORDER = ["王志剛", "張國飛", "張劭如", "謝祥玄", "張懷德", "楊淯舒", "黎祐甄", "廖俊龍", "曾健洋", "劉智敏"];
        const STAFF_INFO = { "廖俊龍": { gender: "M" }, "黎祐甄": { gender: "F" }, "張劭如": { gender: "F" }, "楊淯舒": { gender: "F" }, "劉智敏": { type: "Special", gender: "M" }, "曾健洋": { type: "Special", gender: "M" }, "王志剛": { gender: "M" }, "張國飛": { gender: "M" }, "張懷德": { gender: "M" }, "謝祥玄": { gender: "M" } };

        const formatK = (d) => `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
        const getMonK = (s) => { const d = new Date(s), day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); return formatK(new Date(d.setDate(diff))); };

        const Icon = memo(({ name, className = "w-4 h-4" }) => {
            const icons = {
                refresh: <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-5v5h5m-5 4a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16m0 5v-5h-5" />,
                copy: <path d="M8 4v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7.242a2 2 0 0 0-.602-1.43L16.083 2.57A2 2 0 0 0 14.685 2H10a2 2 0 0 0-2 2z M16 2v4h4 M4 8H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1"/>,
                left: <path d="m15 18-6-6 6-6" />, right: <path d="m9 18 6-6-6-6" />,
                cloud: <path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.2-1.6-4-3.7-4.4-.5-3.1-3.2-5.6-6.3-5.6-2.5 0-4.7 1.5-5.7 3.6-2 .4-3.3 2.1-3.3 4.1C3 15.2 5.2 18 8 18h9.5z" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        });

        const NavGroup = ({ onPrev, onToday, onNext }) => (
            <div className="flex items-center gap-1 bg-white/10 rounded-full px-1 py-1">
                <button onClick={onPrev} className="p-1 text-white/40 active:text-white"><Icon name="left" /></button>
                <button onClick={onToday} className="text-[9px] font-black uppercase px-2 text-blue-400">Today</button>
                <button onClick={onNext} className="p-1 text-white/40 active:text-white"><Icon name="right" /></button>
            </div>
        );

        const StaffButton = memo(({ name, aliasMap = {}, forceName = null, onClick, mode = "normal", isBShift = false, vip = "NONE" }) => {
            const info = STAFF_INFO[name] || { gender: 'M' };
            const disp = forceName || aliasMap[name] || name;
            const colorClass = info?.type === "Special" ? "text-[var(--special-text)]" : info?.gender === "F" ? "text-[var(--women-text)]" : "text-[var(--men-text)]";
            const fontSize = mode === "master" ? "text-[16px]" : (mode === "tiny" ? "text-[14px]" : (mode === "small" ? (name === "廖俊龍" ? "text-[14px]" : "text-[18px]") : (name === "廖俊龍" ? "text-[22px]" : "text-[26px]")));
            const btnClass = `${mode === "small" || mode === "master" ? 'h-8' : 'h-10'} ${fontSize} rounded-[0.6rem] ${isBShift ? 'b-shift-glow' : ''}`;

            return (
                <div className={vip === "VIP2" ? "vip2-orbit-container" : "w-full"}>
                    {vip === "VIP2" && <div className="orbit-base" style={{ color: info.gender === 'F' ? '#FF375F' : '#00FFFF' }}></div>}
                    <button onClick={(e) => { e.stopPropagation(); if(onClick) onClick(name); }} className={`w-full ${btnClass} ${vip === "VIP1" ? 'vip-1-breath' : ''} border border-white/5 bg-white/[0.06] flex items-center justify-center gap-1 relative z-10 ${colorClass} truncate active:scale-95 transition-transform font-bold`}>
                        {(vip === "NONE") && <span className="w-1.5 h-1.5 rounded-full bg-current opacity-80"></span>}
                        {disp}
                    </button>
                </div>
            );
        });

        const App = () => {
            const [dates, setDates] = useState([]), [schedule, setSchedule] = useState({ roster: {}, statuses: {}, shows: {}, notes: {} });
            const [dateIdx, setDateIdx] = useState(0), [weekOffset, setWeekOffset] = useState(0);
            const [isUnlocked, setIsUnlocked] = useState(false), [aliasMap, setAliasMap] = useState({});
            const [queryStaff, setQueryStaff] = useState(null), [queryVenue, setQueryVenue] = useState(null), [showMasterModal, setShowMasterModal] = useState(false);
            const [toast, setToast] = useState(null), [diag, setDiag] = useState("正在同步中...");
            const [vipManager, setVipManager] = useState(false), [vips, setVips] = useState(() => STAFF_ORDER.reduce((acc, n) => ({ ...acc, [n]: "NONE" }), {}));

            const handleBackToday = useCallback(() => {
                const now = new Date(), tK = formatK(now), idx = dates.findIndex(d => d.fullKey === tK); 
                if(idx!==-1) { setDateIdx(idx); const mK = getMonK(dates[0].fullKey), tMon = getMonK(tK); setWeekOffset(Math.max(0, Math.floor((new Date(tMon)-new Date(mK))/(7*24*60*60*1000)))); } 
            }, [dates]);

            useEffect(() => {
                const timer = setInterval(() => {
                    if (window.isFirebaseReady && window.Firebase) {
                        clearInterval(timer);
                        const app = Firebase.initializeApp(FIREBASE_CONFIG);
                        Firebase.signInAnonymously(Firebase.getAuth(app)).then(() => {
                            Firebase.getDoc(Firebase.doc(Firebase.getFirestore(app), 'artifacts', 'tpac-schedule', 'public', 'data', 'configs', 'name_mapping')).then(snap => {
                                if (snap.exists()) setAliasMap(snap.data().maps || {});
                            });
                            Firebase.onSnapshot(Firebase.doc(Firebase.getFirestore(app), 'artifacts', 'tpac-schedule', 'public', 'data', 'rosters', 'master'), (s) => {
                                if (s.exists()) {
                                    const d = s.data(), ros = JSON.parse(d.roster || '{}'), ks = Object.keys(ros).sort();
                                    const sd = ks.map(k => { const dt = new Date(k); return { d: `${dt.getMonth()+1}/${dt.getDate()}`, w: ['日','一','二','三','四','五','六'][dt.getDay()], fullKey: k }; });
                                    setSchedule({ roster: ros, statuses: JSON.parse(d.statuses || '{}'), shows: JSON.parse(d.shows || '{}'), notes: JSON.parse(d.notes || '{}') });
                                    setDates(sd); setIsUnlocked(true);
                                }
                            });
                        });
                    }
                }, 200);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => { if(isUnlocked && dates.length) {
                const tk = formatK(new Date()), idx = dates.findIndex(d => d.fullKey === tk);
                if(idx !== -1) { setDateIdx(idx); const d1 = new Date(getMonK(dates[0].fullKey)), dt = new Date(getMonK(tk)); setWeekOffset(Math.max(0, Math.floor((dt - d1)/(7*24*60*60*1000)))); }
            }}, [isUnlocked, dates]);

            if (!isUnlocked) return (
                <div className="h-screen flex items-center justify-center bg-black overflow-hidden relative">
                    <div className="aura-bg"><div className="aura-orb"></div></div>
                    <div className="unlock-glow-container text-white">
                        <div className="mb-8 relative flex justify-center">
                            <div className="absolute inset-0 bg-blue-500/20 blur-3xl rounded-full core-pulse"></div>
                            <div className="w-32 h-32 border border-white/10 rounded-full flex items-center justify-center relative shadow-inner">
                                <div className="absolute inset-2 border border-blue-500/30 rounded-full animate-spin" style={{animationDuration:'3s', borderTopColor: 'transparent'}}></div>
                                <Icon name="cloud" className="w-12 h-12 text-blue-500" />
                            </div>
                        </div>
                        <h2 className="text-2xl font-black uppercase tracking-widest italic mb-2 text-center">Connecting</h2>
                        <p className="text-[10px] font-bold text-blue-500 uppercase tracking-widest opacity-60 animate-pulse text-center">{diag}</p>
                    </div>
                </div>
            );

            return (
                <div className="h-screen flex flex-col overflow-hidden relative text-white bg-black">
                    <div className="aura-bg"><div className="aura-orb"></div><div className="aura-orb" style={{right:0, bottom:0, animationDelay: '-10s'}}></div></div>
                    {toast && <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[1000] bg-white/20 backdrop-blur px-6 py-2 rounded-full text-xs font-bold">{toast}</div>}

                    <header className="mac-glass pt-10 pb-3 px-4 flex items-center justify-between shrink-0 z-50">
                        <button onClick={handleBackToday} className="bg-blue-600 px-4 h-7 rounded-full text-[10px] font-black uppercase">Today</button>
                        <h1 className="text-xl font-black italic cursor-pointer" onClick={() => setShowMasterModal(true)}>視聽班表系統</h1>
                        <button onClick={()=>window.location.reload()} className="h-7 w-7 rounded-full bg-white/5 border border-white/10 flex items-center justify-center"><Icon name="refresh" /></button>
                    </header>

                    <main className="flex-1 overflow-y-auto px-2 py-3 no-scrollbar pb-24 z-10">
                        <div className="mac-glass sticky top-0 -mx-2 px-2 py-2 flex flex-col mb-4 z-20 shadow-2xl">
                            <div className="flex items-center justify-between mb-2 px-1">
                                <button onClick={() => setWeekOffset(p => Math.max(0, p-1))} className="text-white/30 text-xs">◀ 上週</button>
                                <span className="text-[10px] font-bold opacity-40 uppercase tracking-widest">Navigation</span>
                                <button onClick={() => setWeekOffset(p => p + 1)} className="text-white/30 text-xs">下週 ▶</button>
                            </div>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                {currentWeek.map(d => {
                                    const realIdx = dates.findIndex(ad => ad.fullKey === d.fullKey);
                                    const active = dateIdx === realIdx;
                                    return (
                                        <button key={d.fullKey} disabled={realIdx === -1} onClick={()=>setDateIdx(realIdx)} className={`flex-1 min-w-[45px] py-2 rounded-xl border-2 ${active ? 'border-blue-500 bg-blue-500/10 shadow-lg' : 'border-transparent bg-white/5'} ${realIdx === -1 ? 'opacity-20' : ''}`}>
                                            <span className={`text-[12px] font-black ${d.w==='六'||d.w==='日'?'text-[#FFD1DC]':'text-white/50'}`}>週{d.w}</span>
                                            <span className={`text-base font-black ${active ? 'text-white' : 'text-white/80'}`}>{d.d}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-2 mb-6">
                            {['GT','BB','GP'].map(v=>{
                                const vColor = v==='GT'?'#FF2D55':v==='BB'?'#0A84FF':'#32DE84';
                                return (
                                    <div key={v} className="bg-[#121214] rounded-[1.5rem] flex flex-col border shadow-xl" style={{ borderColor: `${vColor}80` }}>
                                        <button onClick={() => setQueryVenue(v)} className="py-2 font-black text-xl hover:bg-white/5 transition-colors" style={{color: vColor}}>{v}</button>
                                        <div className="px-1 py-1 min-h-[30px] border-b border-white/5 bg-black/40 text-center overflow-hidden">
                                            <p className="text-[14px] font-bold opacity-70 italic truncate">{schedule.shows?.[dates[dateIdx]?.fullKey]?.[v]||""}</p>
                                        </div>
                                        <div className="p-1 space-y-1">
                                            {['A','B'].map(sh=>(
                                                <div key={sh} className="bg-zinc-900/40 rounded-[1.2rem] p-1 flex flex-col gap-1 min-h-[60px]">
                                                    {dData?.s[v][sh].map(n=><StaffButton key={n} name={n} aliasMap={aliasMap} mode="small" onClick={setQueryStaff} isBShift={false} vip={vips[n]} />)}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </main>

                    {showMasterModal && (
                        <div className="fixed inset-0 z-[1000] flex items-center justify-center p-2 bg-black/95 backdrop-blur-3xl" onClick={() => setShowMasterModal(false)}>
                            <div className="bg-[#121214] border border-white/10 w-full max-w-4xl rounded-[2rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 border-b border-white/10 flex items-center justify-between bg-zinc-900/40">
                                    <div className="flex items-center gap-4">
                                        <button onClick={() => setShowMasterModal(false)} className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xl shrink-0">×</button>
                                        <h3 className="text-lg font-black italic">Master Roster</h3>
                                    </div>
                                    <NavGroup onPrev={()=>setWeekOffset(p=>Math.max(0,p-1))} onToday={handleBackToday} onNext={()=>setWeekOffset(p=>p+1)} />
                                </div>
                                <div className="flex-1 overflow-auto p-1 no-scrollbar">
                                    <div className="flex bg-[#1a1a1c] border-b border-white/20 sticky top-0 z-40">
                                        <div onClick={() => setVipManager(!vipManager)} className="master-sticky-col p-2 text-[10px] font-black text-white/40 text-center flex items-center justify-center cursor-help">
                                            {vipManager ? "SAVE" : "STAFF"}
                                        </div>
                                        {currentWeek.map(d => (
                                            <div key={d.fullKey} className={`min-w-[75px] flex-1 p-2 text-center border-l border-white/20 ${d.fullKey === dates[dateIdx]?.fullKey ? 'bg-blue-900/20' : ''}`}>
                                                <div className={`text-[11px] font-black ${d.w === '六' || d.w === '日' ? 'text-[#FFD1DC]' : 'opacity-40'}`}>週{d.w}</div>
                                                <div className="text-[13px] font-bold">{d.d}</div>
                                            </div>
                                        ))}
                                    </div>
                                    {STAFF_ORDER.map(staff => (
                                        <div key={staff} className="flex border-b border-white/[0.04]">
                                            <div className="master-sticky-col py-2 px-1 flex items-center gap-1">
                                                {vipManager && <div onClick={() => setVips(p=>({...p, [staff]: p[staff]==="NONE"?"VIP1":p[staff]==="VIP1"?"VIP2":"NONE"}))} className={`w-4 h-4 rounded-full flex items-center justify-center text-[8px] font-black cursor-pointer transition-colors ${vips[staff]==="VIP1"?'bg-blue-500':vips[staff]==="VIP2"?'bg-cyan-400':'bg-white/10'}`}>{vips[staff]==="NONE"?"":vips[staff]==="VIP1"?"1":"2"}</div>}
                                                <StaffButton name={staff} aliasMap={aliasMap} mode="master" forceName={staff==="廖俊龍"?"阿龍":null} onClick={(s)=>{setShowMasterModal(false); setQueryStaff(s);}} vip={vips[staff]} />
                                            </div>
                                            {currentWeek.map(d => {
                                                let label = "—", cellV = null, isB = false;
                                                ['GT','BB','GP'].forEach(v => { 
                                                    if (schedule.roster[d.fullKey]?.[v]?.[staff]) { 
                                                        label = `${v}-${schedule.roster[d.fullKey][v][staff].shift}`;
                                                        cellV = v; isB = schedule.roster[d.fullKey][v][staff].shift === 'B';
                                                    } 
                                                });
                                                const st = schedule.statuses[d.fullKey]?.[staff] || "";
                                                // 修正 BB 顏色渲染與 B 班邊框發光
                                                const cellBg = isB ? (cellV==='GT'?'#8B0000':cellV==='BB'?'#0A84FF':'#006400') : (cellV==='GT'?'#8B0000':cellV==='BB'?'#0A84FF':'#006400');
                                                const cellOpacity = label === "—" ? 0.03 : isB ? 0.7 : 0.4;
                                                const cellBorder = isB ? "1.5px solid #FFF" : "none";
                                                const cellShadow = isB ? "0 0 12px #FFF" : "none";

                                                if (label === "—" && st.match(/辦公|其他/)) { label = "辦"; return <div key={d.fullKey} className="min-w-[75px] flex-1 p-1 flex items-center justify-center border-l border-white/[0.05]"><div className="w-full h-9 flex items-center justify-center rounded-md bg-[#B36200]/40 text-[#FF9500] text-[13px]">辦</div></div>; } 
                                                else if (label === "—") { label = (st==="" || st.match(/休假|無排班/)) ? "休" : "—"; return <div key={d.fullKey} className="min-w-[75px] flex-1 p-1 flex items-center justify-center border-l border-white/[0.05]"><div className={`w-full h-9 flex items-center justify-center rounded-md ${label==='休'?'bg-[#444444] text-white/80':'bg-white/[0.03] text-white/10'} text-[13px]`}>{label}</div></div>; }
                                                
                                                return <div key={d.fullKey} className="min-w-[75px] flex-1 p-1 flex items-center justify-center border-l border-white/[0.05]">
                                                    <div className="w-full h-9 flex items-center justify-center rounded-md text-white text-[13px] font-bold" style={{ backgroundColor: cellBg, opacity: cellOpacity, border: cellBorder, boxShadow: cellShadow }}>{label}</div>
                                                </div>;
                                            })}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {(queryStaff || queryVenue) && (
                        <div className="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-black/90 backdrop-blur-2xl" onClick={() => { setQueryStaff(null); setQueryVenue(null); }}>
                             <div className="bg-[#121214] border border-white/10 w-full max-w-lg rounded-[2.5rem] shadow-2xl flex flex-col max-h-[85vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 border-b border-white/10 flex items-center justify-between bg-zinc-900/40">
                                    <div className="flex items-center gap-3">
                                        <button onClick={() => { setQueryStaff(null); setQueryVenue(null); }} className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-2xl text-white">×</button>
                                        <h3 className="text-xl font-black italic">{queryVenue ? `${queryVenue} Weekly` : (aliasMap[queryStaff] || queryStaff)}</h3>
                                    </div>
                                    <NavGroup onPrev={()=>setWeekOffset(p=>Math.max(0,p-1))} onToday={handleBackToday} onNext={()=>setWeekOffset(p=>p+1)} />
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar scroll-smooth">
                                    {currentWeek.map(d => {
                                        const isToday = d.fullKey === dates[dateIdx]?.fullKey;
                                        let rowContent;
                                        if (queryVenue) {
                                            rowContent = (
                                                <div className="flex-1 flex flex-col gap-2">
                                                    <p className="text-xs opacity-50 italic truncate">{schedule.shows?.[d.fullKey]?.[queryVenue] || "無演出內容"}</p>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        {['A','B'].map(sh => (<div key={sh} className="bg-black/40 p-1 rounded-lg flex flex-col gap-1 min-h-[40px]">{Object.entries(schedule.roster[d.fullKey]?.[queryVenue]||{}).filter(([_,v])=>v.shift===sh).map(([n])=><StaffButton key={n} name={n} aliasMap={aliasMap} mode="tiny" onClick={setQueryStaff} isBShift={false} vip={vips[n]} />)}</div>))}
                                                    </div>
                                                </div>
                                            );
                                        } else {
                                            let sTxt = "辦公", sCol = "#FF9500";
                                            ['GT','BB','GP'].forEach(v => { if(schedule.roster[d.fullKey]?.[v]?.[queryStaff]) { const sh = schedule.roster[d.fullKey][v][queryStaff].shift; sTxt = `${v}-${sh}`; sCol = sh === 'B' ? '#FF0000' : (v==='BB'?'#0A84FF':'cyan'); } });
                                            if(schedule.statuses[d.fullKey]?.[queryStaff]?.match(/休|例/)) { sTxt = "休假"; sCol = "#8E8E93"; }
                                            rowContent = <span className="text-lg font-black" style={{ color: sCol }}>{sTxt}</span>;
                                        }
                                        return (
                                            <div key={d.fullKey} className={`flex items-start justify-between p-4 rounded-2xl border ${isToday ? 'bg-blue-600/20 border-blue-500 shadow-xl' : 'bg-white/5 border-white/5'}`}>
                                                <div className="flex flex-col shrink-0 w-12"><span className={`text-[12px] font-black ${d.w==='六'||d.w==='日'?'text-[#FFD1DC]':'opacity-40'}`}>週{d.w}</span><span className="text-lg font-bold">{d.d}</span></div>
                                                {rowContent}
                                            </div>
                                        );
                                    })}
                                </div>
                             </div>
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
