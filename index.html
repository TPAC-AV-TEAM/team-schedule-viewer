// ... 前方程式碼保持不變 ...

{(queryStaff || queryVenue) && (
    <div className="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-black/90 backdrop-blur-2xl" onClick={() => { setQueryStaff(null); setQueryVenue(null); }}>
        <div className="bg-[var(--mac-bg)] border border-white/10 w-full max-w-lg rounded-[2.5rem] shadow-2xl flex flex-col max-h-[85vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
            <div className="p-4 border-b border-white/10 flex items-center justify-between bg-[var(--mac-card)]">
                <div className="flex items-center gap-3">
                    <button onClick={() => { setQueryStaff(null); setQueryVenue(null); }} className="w-8 h-8 rounded-full bg-white/10 text-2xl">×</button>
                    <button onClick={handleBackToday} className="btn-today">Today</button>
                    <h3 className="text-xl font-black italic">{queryVenue ? `${queryVenue} Weekly` : (aliasMap[queryStaff] || queryStaff)}</h3>
                </div>
                <div className="flex bg-white/5 rounded-full px-1 py-1">
                    <button onClick={() => shiftWeek(-1)} className="p-1 hover:text-white transition-colors"><Icon name="chevronLeft" className="w-3 h-3" /></button>
                    <button onClick={() => shiftWeek(1)} className="p-1 hover:text-white transition-colors"><Icon name="chevronRight" className="w-3 h-3" /></button>
                </div>
            </div>
            <div id={queryVenue ? "venue-scroll-container" : "staff-scroll-container"} className="flex-1 overflow-y-auto p-3 space-y-3 no-scrollbar scroll-smooth">
                {dates.map((d) => {
                    const isS = d.fullKey === dates[dateIdx]?.fullKey, isW = d.w === '六' || d.w === '日';
                    
                    // --- 修正：廳院週表彈窗 ---
                    if (queryVenue) {
                        const vShowName = schedule.shows[d.fullKey]?.[queryVenue] || "";
                        return (
                            <div key={d.fullKey} id={`modal-row-${d.fullKey}`} className={`day-block-card ${isS ? 'day-block-today' : ''}`}>
                                <div className={`mb-2 pb-2 border-b border-white/10 text-sm font-light italic opacity-60 text-right overflow-hidden`}>
                                    <div className="marquee-container">
                                        <span className={vShowName.length > 10 ? "marquee-text-slow" : ""}>
                                            {vShowName || "—"}
                                        </span>
                                    </div>
                                </div>
                                <div className="flex items-start gap-4">
                                    <div className="flex flex-col text-left pr-2 border-r border-white/10 w-20 leading-none justify-center">
                                        <span className={`font-black mb-1 text-[12px] ${isW ? 'text-[var(--weekend-pink)]' : 'text-white/50'}`}>週{d.w}</span>
                                        <span className={`text-[24px] font-black tracking-tighter ${isW ? 'text-[var(--weekend-pink)]' : ''}`}>{d.d}</span>
                                    </div>
                                    <div className="flex-1 grid grid-cols-2 gap-2">{['A','B'].map(sh => (<div key={sh} className="bg-black/20 rounded-xl p-1 min-h-[40px] flex flex-col gap-1">{Object.entries(schedule.roster[d.fullKey]?.[queryVenue]||{}).filter(([_,v])=>v.shift===sh).map(([n])=><StaffButton key={n} name={n} aliasMap={aliasMap} onClick={handleStaffClick} mode="small" />)}</div>))}</div>
                                </div>
                            </div>
                        );
                    }

                    // --- 修正：個人週表彈窗 ---
                    let st = "辦公", co = "#FF9500", hasS = false, activeV = "";
                    ['GT','BB','GP'].forEach(v => { if (schedule.roster[d.fullKey]?.[v]?.[queryStaff]) { const sh = schedule.roster[d.fullKey][v][queryStaff].shift; st = `${v}-${sh}`; co = v==='GP'?'#32DE84':v==='BB'?'#00FFFF':'#FF2D55'; hasS = true; activeV = v; } }); 
                    if (schedule.statuses[d.fullKey]?.[queryStaff]?.match(/休|例|假/)) { st = "休假"; co = "#8E8E93"; }
                    const pShowName = hasS ? (schedule.shows[d.fullKey]?.[activeV] || "") : "";
                    
                    return (
                        <div key={d.fullKey} id={`modal-row-${d.fullKey}`} className={`flex items-center gap-3 day-block-card ${isS ? 'day-block-today' : ''}`}>
                            <div className="flex flex-col text-left pr-3 border-r border-white/10 w-20 leading-none shrink-0 justify-center">
                                <span className={`font-black mb-1 text-[12px] ${isW ? 'text-[var(--weekend-pink)]' : 'text-white/50'}`}>週{d.w}</span>
                                <span className={`text-[24px] font-black tracking-tighter ${isW ? 'text-[var(--weekend-pink)]' : ''}`}>{d.d}</span>
                            </div>
                            <div className="flex-1 marquee-container text-[18px] font-light text-white opacity-50 italic">
                                <span className={pShowName.length > 10 ? "marquee-text-slow" : ""}>
                                    {pShowName}
                                </span>
                            </div>
                            <span className={`text-lg font-black px-3 py-1 rounded-lg shrink-0`} style={{ color: co }}>{st}</span>
                        </div>
                    );
                })}
            </div>
        </div>
    </div>
)}

// ... 後方程式碼保持不變 ...
