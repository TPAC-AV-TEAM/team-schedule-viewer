<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>視聽班表系統 | V6.5 Final</title>

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta id="theme-meta" name="theme-color" content="#000000">
    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%E8%A6%96%E8%81%BD%E7%8F%AD%E8%A1%A8%E7%B3%BB%E7%B5%B1%22%2C%22short_name%22%3A%22%E8%A6%96%E8%81%BD%E7%8F%AD%E8%A1%A8%22%2C%22display%22%3A%22standalone%22%2C%22start_url%22%3A%22.%22%2C%22background_color%22%3A%22%23000000%22%2C%22theme_color%22%3A%22%23000000%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F2665%2F2665123.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D" />

    <script>
        (function() {
            try {
                var theme = localStorage.getItem('app-theme');
                // 修正：如果有人存了奇怪的舊值，強行修正回 dark
                if (theme !== 'light' && theme !== 'dark') theme = 'dark';
                document.documentElement.setAttribute('data-theme', theme);
            } catch (e) {
                // 如果是無痕模式禁止讀取，則預設 dark
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.Firebase = { initializeApp, getApps, getApp, getFirestore, doc, onSnapshot, getDoc, getAuth, signInAnonymously, onAuthStateChanged };
        window.isFirebaseReady = true;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&family=Noto+Sans+TC:wght@100;400;700;900&display=swap');
        
        :root { 
            /* 黑夜模式 - 變數 */
            --bg-app: #000000; --bg-card: #121214; --bg-glass: rgba(18, 18, 20, 0.85);
            --text-main: #FFFFFF; --text-dim: rgba(255,255,255,0.4);
            --border-light: rgba(255,255,255,0.1); --btn-bg: rgba(255,255,255,0.06);
            --orb-color: #0a183d; --aura-op: 0.15;
            --col-gt: #FF2D55; --col-bb: #00FFFF; --col-gp: #32DE84;
            --col-men: #E0F7FF; --dot-men: #00FFFF;
            --col-women: #FFD6E0; --dot-women: #FF375F;
            --col-special: #FFFFE0; --dot-special: #FFD60A;
            --shift-bg-op: 0.2; --shift-border: transparent;
        }

        [data-theme='light'] {
            /* 白天模式 - 變數 */
            --bg-app: #FFFFFF; --bg-card: #F2F2F7; --bg-glass: rgba(255, 255, 255, 0.95);
            --text-main: #000000; --text-dim: rgba(0,0,0,0.6);
            --border-light: rgba(0,0,0,0.1); --btn-bg: #E5E5EA;
            --orb-color: #E5E5EA; --aura-op: 0.05;
            --col-gt: #D70015; --col-bb: #008B8B; --col-gp: #006400;
            --col-men: #004080; --dot-men: #0055FF;
            --col-women: #B00020; --dot-women: #D70015;
            --col-special: #8B6508; --dot-special: #FFCC00;
            --shift-bg-op: 0; --shift-border: rgba(0,0,0,0.1);
        }

        html, body { height: 100%; width: 100%; margin: 0; background-color: var(--bg-app); color: var(--text-main); transition: background-color 0.3s ease; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }
        
        .aura-bg { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, var(--orb-color) 0%, var(--bg-app) 100%); z-index: 0; pointer-events: none; }
        .aura-orb { position: absolute; width: 700px; height: 700px; background: radial-gradient(circle, #0A84FF 0%, transparent 70%); opacity: var(--aura-op); filter: blur(80px); animation: orb-move 25s infinite alternate ease-in-out; }
        @keyframes orb-move { 0% { transform: translate(-15%, -15%); } 100% { transform: translate(15%, 15%); } }
        
        .mac-glass { background: var(--bg-glass); backdrop-filter: blur(30px); border-bottom: 1px solid var(--border-light); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @keyframes note-breath { 0%, 100% { opacity: 1; } 50% { color: #FF3B30; opacity: 0.8; } }
        .note-active-text { animation: note-breath 3s infinite ease-in-out; }
        
        .b-shift-glow { animation: b-glow 1.5s infinite alternate; border: 1.5px solid var(--text-main) !important; }
        @keyframes b-glow { 0% { box-shadow: 0 0 2px var(--text-dim); } 100% { box-shadow: 0 0 10px #0A84FF; } }

        .vip-1-text-breath { animation: vip-pulse 1.8s infinite alternate ease-in-out; font-weight: 900 !important; }
        @keyframes vip-pulse { 0% { text-shadow: none; } 100% { text-shadow: 0 0 8px var(--text-main); } }

        .master-sticky-col { position: sticky; left: 0; z-index: 30; background-color: var(--bg-card); min-width: 75px; border-right: 1px solid var(--border-light); }
        .core-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(0.95); opacity: 0.5; } 50% { transform: scale(1.05); opacity: 0.8; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, memo, useCallback } = React;

        const FIREBASE_CONFIG = { apiKey: "AIzaSyAx2aYlfqHBUe3V7a3sT5ZPVNYyr2JY8OA", authDomain: "tpac-schedule.firebaseapp.com", projectId: "tpac-schedule", storageBucket: "tpac-schedule.firebasestorage.app", messagingSenderId: "70955835780", appId: "1:70955835780:web:9d3b0958738557d1f7fdd1" };
        const STAFF_ORDER = ["王志剛", "張國飛", "張劭如", "謝祥玄", "張懷德", "楊淯舒", "黎祐甄", "廖俊龍", "曾健洋", "劉智敏"];
        const STAFF_INFO = { 
            "廖俊龍": { type: "Normal", gender: "M" }, "張劭如": { type: "Normal", gender: "F" }, 
            "楊淯舒": { type: "Normal", gender: "F" }, "黎祐甄": { type: "Normal", gender: "F" }, 
            "劉智敏": { type: "Special", gender: "M" }, "曾健洋": { type: "Special", gender: "M" }, 
            "王志剛": { type: "Normal", gender: "M" }, "張國飛": { type: "Normal", gender: "M" }, 
            "張懷德": { type: "Normal", gender: "M" }, "謝祥玄": { type: "Normal", gender: "M" } 
        };

        const formatK = (d) => `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
        const getMonK = (s) => { const d = new Date(s), day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); return formatK(new Date(d.setDate(diff))); };

        const Icon = memo(({ name, className = "w-4 h-4" }) => {
            const icons = {
                refresh: <React.Fragment><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /><path d="M16 21h5v-5" /></React.Fragment>,
                sun: <path d="M12 12m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0M12 2v2M12 20v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M2 12h2M20 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />,
                moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />,
                cloud: <path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.2-1.6-4-3.7-4.4-.5-3.1-3.2-5.6-6.3-5.6-2.5 0-4.7 1.5-5.7 3.6-2 .4-3.3 2.1-3.3 4.1C3 15.2 5.2 18 8 18h9.5z" />,
                info: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></React.Fragment>,
                briefcase: <React.Fragment><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></React.Fragment>,
                copy: <path d="M8 4v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7.242a2 2 0 0 0-.602-1.43L16.083 2.57A2 2 0 0 0 14.685 2H10a2 2 0 0 0-2 2z M16 2v4h4 M4 8H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1"/>,
                chevronLeft: <path d="m15 18-6-6 6-6" />, chevronRight: <path d="m9 18 6-6-6-6" />, check: <path d="M20 6 9 17l-5-5" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        });

        const StaffButton = memo(({ name, aliasMap = {}, mode = "normal", isBShift = false, showGlow = false, onClick }) => {
            const info = STAFF_INFO[name] || { gender: 'M' };
            const disp = aliasMap[name] || name;
            const colorVar = info?.type === "Special" ? "var(--col-special)" : info?.gender === "F" ? "var(--col-women)" : "var(--col-men)";
            const dotVar = info?.type === "Special" ? "var(--dot-special)" : info?.gender === "F" ? "var(--dot-women)" : "var(--dot-men)";
            const fontSize = mode === "tiny" ? "text-[14px]" : (mode === "small" ? (name === "廖俊龍" ? "text-[14px]" : "text-[18px]") : (mode === "master" ? "text-[16px]" : (name === "廖俊龍" ? "text-[22px]" : "text-[26px]")));
            return (
                <button onClick={(e) => { e.stopPropagation(); onClick(name); }} className={`w-full ${fontSize} ${mode === "small" || mode === "master" ? 'h-8' : 'h-10'} rounded-[0.6rem] ${info.vipTag === "VIP1" ? "vip-1-text-breath" : ""} font-black border border-[var(--border-light)] bg-[var(--btn-bg)] flex items-center justify-center gap-1 shadow-sm truncate shrink-0 active:scale-95 transition-all`} style={{ color: colorVar }}>
                    <span className="w-1 h-1 rounded-full shadow-[0_0_5px_currentColor]" style={{ backgroundColor: dotVar }}></span>{disp}
                </button>
            );
        });

        const App = () => {
            const [dates, setDates] = useState([]), [schedule, setSchedule] = useState({ roster: {}, statuses: {}, shows: {}, notes: {} });
            const [dateIdx, setDateIdx] = useState(0), [weekOffset, setWeekOffset] = useState(0);
            const [isUnlocked, setIsUnlocked] = useState(false), [user, setUser] = useState(null);
            const [aliasMap, setAliasMap] = useState({}), [queryStaff, setQueryStaff] = useState(null), [queryVenue, setQueryVenue] = useState(null);
            const [showMasterModal, setShowMasterModal] = useState(false), [toast, setToast] = useState(null);
            const [theme, setTheme] = useState(() => { try { return localStorage.getItem('app-theme') || 'dark'; } catch(e) { return 'dark'; } });

            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
                try { localStorage.setItem('app-theme', theme); } catch(e) {}
                document.getElementById('theme-meta').setAttribute('content', theme === 'dark' ? '#000000' : '#FFFFFF');
            }, [theme]);

            const handleBackToday = useCallback(() => {
                if (!dates.length) return;
                const tK = formatK(new Date()), idx = dates.findIndex(d => d.fullKey === tK); 
                if(idx!==-1) { setDateIdx(idx); setWeekOffset(Math.max(0, Math.floor((new Date(getMonK(tK))-new Date(getMonK(dates[0].fullKey)))/(7*24*60*60*1000)))); } 
            }, [dates]);

            useEffect(() => {
                const init = setInterval(() => {
                    if (window.isFirebaseReady) {
                        clearInterval(init);
                        const app = Firebase.initializeApp(FIREBASE_CONFIG);
                        Firebase.signInAnonymously(Firebase.getAuth(app)).then(() => {
                            Firebase.onAuthStateChanged(Firebase.getAuth(app), async (u) => { 
                                if(u) {
                                    setUser(u);
                                    const mapSnap = await Firebase.getDoc(Firebase.doc(Firebase.getFirestore(app), 'artifacts', 'tpac-schedule', 'public', 'data', 'configs', 'name_mapping'));
                                    if (mapSnap.exists()) setAliasMap(mapSnap.data().maps || {});
                                }
                            });
                        });
                    }
                }, 200);
                return () => clearInterval(init);
            }, []);

            useEffect(() => {
                if (!user) return;
                return Firebase.onSnapshot(Firebase.doc(Firebase.getFirestore(), 'artifacts', 'tpac-schedule', 'public', 'data', 'rosters', 'master'), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data(), roster = JSON.parse(data.roster || '{}');
                        const keys = Object.keys(roster).sort();
                        setDates(keys.map(k => { const d = new Date(k); return { d: `${d.getMonth()+1}/${d.getDate()}`, w: ['日','一','二','三','四','五','六'][d.getDay()], fullKey: k }; }));
                        setSchedule({ roster, statuses: JSON.parse(data.statuses || '{}'), shows: JSON.parse(data.shows || '{}'), notes: JSON.parse(data.notes || '{}') });
                        setIsUnlocked(true);
                        const tK = formatK(new Date()), m = keys.indexOf(tK);
                        if (m !== -1) { setDateIdx(m); setWeekOffset(Math.max(0, Math.floor((new Date(getMonK(tK))-new Date(getMonK(keys[0])))/(7*24*60*60*1000)))); }
                    }
                });
            }, [user]);

            const currentWeek = useMemo(() => {
                if (!dates.length) return [];
                const anchor = new Date(getMonK(dates[0].fullKey)); anchor.setDate(anchor.getDate() + (weekOffset*7));
                return Array.from({length:7}, (_, i) => { const c = new Date(anchor); c.setDate(c.getDate() + i); const k = formatK(c); return dates.find(d => d.fullKey === k) || { d: `${c.getMonth()+1}/${c.getDate()}`, w: ['日','一','二','三','四','五','六'][c.getDay()], fullKey: k, isPlaceholder: true }; });
            }, [dates, weekOffset]);

            const dData = useMemo(() => {
                const d = dates[dateIdx]; if (!d) return null;
                const res = { s: { GT:{A:[],B:[]}, BB:{A:[],B:[]}, GP:{A:[],B:[]}, "辦公":[], "休假":[] } };
                const rawR = schedule.roster[d.fullKey] || {}, rawS = schedule.statuses[d.fullKey] || {};
                const hasShift = new Set();
                ['GT','BB','GP'].forEach(v => Object.entries(rawR[v]||{}).forEach(([n,val]) => { if(res.s[v][val.shift]) { res.s[v][val.shift].push(n); hasShift.add(n); } }));
                STAFF_ORDER.forEach(n => {
                    const code = rawS[n] || "";
                    if (code.match(/辦公|其他/)) res.s["辦公"].push(n);
                    else if (!hasShift.has(n) && (code === "" || code.match(/休假|無排班|公假/))) res.s["休假"].push(n);
                });
                return res;
            }, [dateIdx, dates, schedule]);

            if (!isUnlocked || !dates.length) return (
                <div className="h-screen flex items-center justify-center bg-black overflow-hidden relative">
                    <div className="aura-bg"></div>
                    <div className="text-center text-white z-10">
                        <div className="w-24 h-24 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
                        <p className="font-black uppercase tracking-widest text-xs animate-pulse">Connecting Firebase...</p>
                    </div>
                </div>
            );

            return (
                <div className="h-screen flex flex-col overflow-hidden relative transition-colors duration-300">
                    <div className="aura-bg"><div className="aura-orb"></div></div>
                    {toast && <div className="fixed top-20 left-1/2 -translate-x-1/2 z-[1000] bg-[var(--bg-card)] backdrop-blur border border-[var(--border-light)] px-6 py-2 rounded-full text-xs font-black animate-bounce shadow-xl text-[var(--text-main)]">{toast}</div>}

                    <header className="mac-glass pt-10 pb-3 px-4 flex items-center justify-between shrink-0 z-50">
                        <button onClick={handleBackToday} className="bg-blue-600 px-4 h-7 rounded-full text-[10px] font-black uppercase shadow-lg text-white active:scale-95 transition-all">Today</button>
                        <h1 onClick={() => setShowMasterModal(true)} className="text-xl font-black tracking-widest uppercase italic hover:text-[#0A84FF] transition-colors cursor-pointer text-[var(--text-main)]">視聽班表系統</h1>
                        <div className="flex gap-2">
                            <button onClick={()=>setTheme(theme==='dark'?'light':'dark')} className="h-7 w-7 rounded-full bg-[var(--btn-bg)] border border-[var(--border-light)] flex items-center justify-center text-[var(--text-main)]"><Icon name={theme==='dark'?'sun':'moon'} /></button>
                            <button onClick={()=>window.location.reload()} className="h-7 w-7 rounded-full bg-[var(--btn-bg)] border border-[var(--border-light)] flex items-center justify-center text-[var(--text-main)]"><Icon name="refresh" /></button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto px-2 py-3 no-scrollbar pb-24 z-10">
                        <div className="mac-glass sticky top-0 -mx-2 px-2 py-2 flex flex-col mb-4 z-20 shadow-xl overflow-hidden">
                            <div className="flex items-center justify-between mb-2 px-1 text-[var(--text-dim)]">
                                <button onClick={() => setWeekOffset(prev => Math.max(0, prev-1))} className="hover:text-[var(--text-main)] p-2 text-xs">◀ 上週</button>
                                <span className="text-[10px] font-black tracking-widest uppercase">Week View</span>
                                <button onClick={() => setWeekOffset(prev => prev + 1)} className="hover:text-[var(--text-main)] p-2 text-xs">下週 ▶</button>
                            </div>
                            <div className="flex gap-2 overflow-x-auto no-scrollbar justify-between">
                                {currentWeek.map(d => {
                                    const realIdx = dates.findIndex(ad => ad.fullKey === d.fullKey);
                                    const active = dateIdx === realIdx, isW = d.w === '六' || d.w === '日';
                                    return (
                                        <button key={d.fullKey} disabled={realIdx===-1} onClick={()=>setDateIdx(realIdx)} className={`flex-1 min-w-[45px] py-2 rounded-xl transition-all flex flex-col items-center justify-center border-2 ${active ? 'border-blue-500 bg-blue-500/10 shadow-[0_0_10px_rgba(10,132,255,0.4)]' : (!active && !isW ? 'border-transparent bg-[var(--btn-bg)] opacity-40' : 'border-transparent bg-[var(--btn-bg)]')} ${realIdx===-1?'opacity-10':''}`}>
                                            <span className={`text-[9px] font-black uppercase ${isW ? 'text-[var(--col-gt)]' : 'text-[var(--text-dim)]'}`}>週{d.w}</span>
                                            <span className={`text-base font-black leading-none ${active ? 'text-[#0A84FF]' : isW ? 'text-[var(--col-gt)]' : 'text-[var(--text-main)]'}`}>{d.d}</span>
                                        </button>
                                    );
                                })}
                            </div>
                            {dates[dateIdx] && schedule.notes[dates[dateIdx].fullKey] && (
                                <div className="mt-3 px-1"><div className="bg-[var(--bg-card)] border border-[var(--border-main)] rounded-xl px-4 py-3 flex items-start gap-3 shadow-md relative overflow-hidden"><div className="absolute left-0 top-0 bottom-0 w-1.5 bg-[#FF3B30] shadow-[0_0_10px_#FF3B30]"></div><span className="shrink-0 mt-1 text-[#FF3B30] animate-pulse"><Icon name="info" /></span><p className="text-[15px] font-black leading-relaxed note-active-text">{schedule.notes[dates[dateIdx].fullKey]}</p></div></div>
                            )}
                        </div>

                        <div className="grid grid-cols-3 gap-2 mb-6">
                            {['GT','BB','GP'].map(v => {
                                const vColor = v==='GT'?'var(--col-gt)':v==='BB'?'var(--col-bb)':'var(--col-gp)';
                                return (
                                    <div key={v} className="bg-[var(--bg-card)] rounded-[1.5rem] overflow-hidden flex flex-col shadow-sm border border-[var(--border-light)]">
                                        <button onClick={() => setQueryVenue(v)} className="py-2 font-black text-xl bg-[var(--btn-bg)] active:opacity-50" style={{color: vColor}}>{v}</button>
                                        <div className="px-1 py-1 min-h-[30px] flex items-center justify-center border-b border-[var(--border-light)] bg-[var(--bg-app)] opacity-70 overflow-hidden text-[var(--text-main)] text-center">
                                            <div className="marquee-wrapper"><p className={`text-[13px] font-black italic ${schedule.shows?.[dates[dateIdx]?.fullKey]?.[v]?.length > 8 ? 'marquee-active' : ''}`}>{schedule.shows?.[dates[dateIdx]?.fullKey]?.[v]||""}</p></div>
                                        </div>
                                        <div className="p-1 space-y-1">
                                            {['A','B'].map(shift=>(<div key={shift} className="bg-[var(--bg-app)] rounded-[1.2rem] p-1 flex flex-col gap-1 min-h-[60px] border border-[var(--border-light)]">{dData?.s[v][shift].map(n=><StaffButton key={n} name={n} aliasMap={aliasMap} onClick={setQueryStaff} mode="small" isBShift={shift==='B'} />)}</div>))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="space-y-4 px-1">
                            <section className="bg-[var(--bg-card)] border border-[var(--border-light)] rounded-[1.5rem] p-4 shadow-sm"><h4 className="text-orange-600 text-[14px] font-black uppercase mb-3 flex items-center gap-2"><Icon name="briefcase" /> 辦公人員</h4><div className="grid grid-cols-4 gap-2">{dData?.s?.["辦公"]?.map(n=>(<StaffButton key={n} name={n} aliasMap={aliasMap} onClick={setQueryStaff} mode="tiny" />))}</div></section>
                            <section className="bg-[var(--bg-card)] border border-[var(--border-light)] rounded-[1.5rem] p-4 shadow-sm"><h4 className="text-[var(--text-dim)] text-[14px] font-black uppercase mb-3 flex items-center gap-2"><Icon name="sun" /> 今日休假</h4><div className="grid grid-cols-4 gap-2">{dData?.s?.["休假"]?.map(n=>(<StaffButton key={n} name={n} aliasMap={aliasMap} onClick={setQueryStaff} mode="tiny" />))}</div></section>
                        </div>
                    </main>

                    {showMasterModal && (
                        <div className="fixed inset-0 z-[1000] flex items-center justify-center p-2 bg-black/60 backdrop-blur-xl" onClick={() => setShowMasterModal(false)}>
                            <div className="bg-[var(--bg-card)] border border-[var(--border-light)] w-full max-w-4xl rounded-[2rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 border-b border-[var(--border-light)] flex items-center justify-between bg-[var(--btn-bg)] text-[var(--text-main)]">
                                    <div className="flex items-center gap-4"><button onClick={() => setShowMasterModal(false)} className="w-8 h-8 rounded-full bg-[var(--border-light)] flex items-center justify-center text-xl shrink-0">×</button><h3 className="text-lg font-black uppercase italic">Master Roster</h3></div>
                                    <div className="flex items-center gap-1 bg-[var(--border-light)] rounded-full px-1.5 py-1">
                                        <button onClick={() => setWeekOffset(prev => Math.max(0, prev-1))} className="p-1 text-[var(--text-dim)]"><Icon name="chevronLeft" /></button>
                                        <button onClick={handleBackToday} className="text-[9px] text-[var(--text-dim)] font-black px-1">Today</button>
                                        <button onClick={() => setWeekOffset(prev => prev + 1)} className="p-1 text-[var(--text-dim)]"><Icon name="chevronRight" /></button>
                                    </div>
                                </div>
                                <div id="master-scroll-container" className="flex-1 overflow-auto p-1 no-scrollbar scroll-smooth bg-[var(--bg-app)]">
                                    <div className="master-table-container">
                                        <div className="flex bg-[var(--btn-bg)] border-b border-[var(--border-light)] sticky top-0 z-40 text-[var(--text-main)]">
                                            <div className="master-sticky-col p-2 text-[9px] font-black opacity-30 uppercase text-center flex items-center justify-center border-b border-[var(--border-light)]">STAFF</div>
                                            {currentWeek.map(d => (
                                                <div key={d.fullKey} id={`master-col-${d.fullKey}`} className={`min-w-[75px] flex-1 p-2 text-center border-l border-[var(--border-light)] ${d.fullKey===dates[dateIdx]?.fullKey?'bg-blue-500/10':''}`}>
                                                    <div className={`text-[8px] uppercase ${d.w==='六'||d.w==='日'?'text-[var(--col-gt)]':'opacity-40'}`}>週{d.w}</div>
                                                    <div className={`text-[13px] font-black ${d.w==='六'||d.w==='日'?'text-[var(--col-gt)]':''}`}>{d.d}</div>
                                                    {d.fullKey===dates[dateIdx]?.fullKey && <div className="h-2 w-2 bg-cyan-400 rounded-full mx-auto mt-1 shadow-[0_0_10px_cyan] animate-pulse"></div>}
                                                </div>
                                            ))}
                                        </div>
                                        {STAFF_ORDER.map((staff, sIdx) => (
                                            <div key={staff} className={`flex border-b border-[var(--border-light)] ${sIdx % 2 === 0 ? 'bg-[var(--btn-bg)] opacity-60' : ''}`}>
                                                <div className="master-sticky-col py-2 px-1 flex items-center bg-[var(--bg-card)]"><StaffButton name={staff} aliasMap={aliasMap} mode="master" onClick={(s) => { setShowMasterModal(false); setQueryStaff(s); }} /></div>
                                                {currentWeek.map(d => {
                                                    const dk = d.fullKey; let label = "—", cls = "opacity-10", hasShift = false;
                                                    ['GT','BB','GP'].forEach(v => { if (schedule.roster[dk]?.[v]?.[staff]) { 
                                                        const shift = schedule.roster[dk][v][staff].shift; 
                                                        const color = v === 'GT' ? 'var(--col-gt)' : v === 'BB' ? 'var(--col-bb)' : 'var(--col-gp)'; 
                                                        label = `${v}-${shift}`; 
                                                        cls = `bg-[${color}]/[var(--shift-bg-op)] text-[var(--text-main)] font-black text-[13px] border border-[${color}]/[var(--shift-border)] ${shift==='B'?'b-shift-glow':''}`; hasShift = true; 
                                                    } });
                                                    const st = schedule.statuses[dk]?.[staff] || "";
                                                    if (st.match(/辦公|其他/)) { label = "辦"; cls = "bg-orange-500/20 text-orange-600 font-black"; } else if (!hasShift && (st === "" || st.match(/休假|無排班/))) { label = "休"; cls = "bg-[var(--border-light)] text-[var(--text-dim)] font-black"; }
                                                    return (<div key={dk} className={`min-w-[75px] flex-1 p-1 flex items-center justify-center border-l border-[var(--border-light)] ${dk===dates[dateIdx]?.fullKey?'bg-blue-500/5':''}`}><div className={`w-full h-9 flex items-center justify-center rounded-md ${cls}`}>{label}</div></div>);
                                                })}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {(queryStaff || queryVenue) && (
                        <div className="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-black/70 backdrop-blur-xl" onClick={() => { setQueryStaff(null); setQueryVenue(null); }}>
                            <div className="bg-[var(--bg-card)] border border-[var(--border-main)] w-full max-w-lg rounded-[2.5rem] shadow-2xl flex flex-col max-h-[85vh] overflow-hidden" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 border-b border-[var(--border-light)] flex items-center justify-between bg-[var(--btn-bg)] text-[var(--text-main)]">
                                    <div className="flex items-center gap-3"><button onClick={() => { setQueryStaff(null); setQueryVenue(null); }} className="w-8 h-8 rounded-full bg-[var(--border-light)] flex items-center justify-center text-2xl">×</button><h3 className="text-xl font-black italic">{queryVenue ? `${queryVenue} Weekly` : (aliasMap[queryStaff] || queryStaff)}</h3></div>
                                    <div className="flex gap-2">
                                        <div className="flex items-center bg-[var(--border-light)] rounded-full overflow-hidden">
                                            <button onClick={() => setWeekOffset(prev => Math.max(0, prev-1))} className="p-2 hover:bg-[var(--border-light)]"><Icon name="chevronLeft" /></button>
                                            <button onClick={handleBackToday} className="px-2 text-[8px] font-black opacity-30">TODAY</button>
                                            <button onClick={() => setWeekOffset(prev => prev + 1)} className="p-2 hover:bg-[var(--border-light)]"><Icon name="chevronRight" /></button>
                                        </div>
                                        <button onClick={() => { 
                                            const text = queryVenue ? `${queryVenue} 週表:\n` + currentWeek.map(d => `${d.d}(${d.w}): 班表資料`).join('\n') : `${aliasMap[queryStaff]||queryStaff} 週表`;
                                            navigator.clipboard.writeText(text); setToast("已複製"); setTimeout(()=>setToast(null), 2000);
                                        }} className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center shadow-lg active:scale-90 text-white"><Icon name="copy" /></button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-3 space-y-3 no-scrollbar bg-[var(--bg-app)]">
                                    {currentWeek.map(d => {
                                        const isS = d.fullKey === dates[dateIdx]?.fullKey, isW = d.w === '六' || d.w === '日';
                                        let label = "辦公", color = "#FF9500", hasShift = false;
                                        if (queryVenue) {
                                            const sA = Object.entries(schedule.roster[d.fullKey]?.[queryVenue]||{}).filter(([_,v])=>v.shift==='A').map(([n])=>aliasMap[n]||n).join('、');
                                            const sB = Object.entries(schedule.roster[d.fullKey]?.[queryVenue]||{}).filter(([_,v])=>v.shift==='B').map(([n])=>aliasMap[n]||n).join('、');
                                            return (<div key={d.fullKey} className={`p-3 rounded-2xl border ${isS?'bg-blue-600/10 border-blue-500 shadow-xl':'bg-[var(--bg-card)] border-[var(--border-light)]'}`}><div className="flex items-center justify-between border-b border-[var(--border-light)] pb-2 mb-2"><span className={`font-black ${isW?'text-[var(--col-gt)]':'text-[var(--text-dim)]'}`}>{d.d} ({d.w})</span><span className="text-xs italic opacity-40">{schedule.shows[d.fullKey]?.[queryVenue]||""}</span></div><div className="grid grid-cols-2 gap-2 text-sm"><div className="bg-[var(--bg-app)] p-2 rounded-lg border border-[var(--border-light)]"><span className="text-[var(--text-dim)]">早</span> {sA||"—"}</div><div className="bg-[var(--bg-app)] p-2 rounded-lg border border-[var(--border-light)]"><span className="text-[var(--text-dim)]">晚</span> {sB||"—"}</div></div></div>);
                                        }
                                        ['GT','BB','GP'].forEach(v => { if (schedule.roster[d.fullKey]?.[v]?.[queryStaff]) { label = `${v}-${schedule.roster[d.fullKey][v][queryStaff].shift}`; color = schedule.roster[d.fullKey][v][queryStaff].shift==='A' ? "#0A84FF" : "#FF3B30"; hasShift = true; } });
                                        if (!hasShift && (schedule.statuses[d.fullKey]?.[queryStaff]?.match(/休|無排班/))) { label = "休假"; color = "var(--text-dim)"; }
                                        return (<div key={d.fullKey} className={`flex items-center justify-between p-4 rounded-2xl border ${isS?'bg-blue-600/10 border-blue-500 shadow-xl':'bg-[var(--bg-card)] border-[var(--border-light)]'}`}><span className={`font-black ${isW?'text-[var(--col-gt)]':'text-[var(--text-main)]'}`}>{d.d} (週{d.w})</span><span className="text-lg font-black" style={{color}}>{label}</span></div>);
                                    })}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
