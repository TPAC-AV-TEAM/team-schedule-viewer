<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>視聽班表系統 | V4.5 Cleaned</title>

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href='data:application/manifest+json;utf8,{"name": "視聽班表系統", "short_name": "視聽班表", "display": "standalone", "start_url": ".", "background_color": "#000000", "theme_color": "#000000", "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/2907/2907253.png", "sizes": "512x512", "type": "image/png"}]}' />

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        window.Firebase = { initializeApp, getApps, getApp, getFirestore, doc, onSnapshot, getDoc, getAuth, signInAnonymously, onAuthStateChanged };
        window.isFirebaseReady = true;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;400;700;900&family=Noto+Sans+TC:wght@100;400;700;900&display=swap');
        :root { 
            --mac-bg: #000000; --mac-card: #121214; --mac-blue: #0A84FF; 
            --vip-text: #FFFFFF; --women-text: #FFD6E0; --men-text: #E0F7FF; --special-text: #FFFFE0;
            --women-dot: #FF375F; --men-dot: #00FFFF; --special-dot: #FFD60A;
            --master-gt: #8B0000; --master-bb: #008B8B; --master-gp: #006400; 
            --ios-red: #FF3B30;
        }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; height: 100vh; overflow: hidden; background: #000000; color: #FFFFFF; -webkit-font-smoothing: antialiased; }
        .aura-bg { position: fixed; inset: 0; background: radial-gradient(circle at 50% 50%, #0a183d 0%, #000000 100%); z-index: 0; pointer-events: none; }
        .aura-orb { position: absolute; width: 700px; height: 700px; background: radial-gradient(circle, rgba(10, 132, 255, 0.08) 0%, transparent 70%); filter: blur(80px); animation: orb-move 25s infinite alternate ease-in-out; }
        @keyframes orb-move { 0% { transform: translate(-15%, -15%); } 100% { transform: translate(15%, 15%); } }
        .mac-glass { background: rgba(18, 18, 20, 0.85); backdrop-filter: blur(40px) saturate(200%); border-bottom: 0.5px solid rgba(255,255,255,0.12); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @keyframes note-breath {
            0% { color: #FFFFFF; opacity: 1; }
            50% { color: #FFD1DC; opacity: 0.8; }
            100% { color: #FFFFFF; opacity: 1; }
        }
        .note-active-text { animation: note-breath 3s infinite ease-in-out; }

        .b-shift-glow { animation: b-glow-strong 1.5s infinite alternate; border: 1.5px solid #FFFFFF !important; }
        @keyframes b-glow-strong { 0% { box-shadow: 0 0 2px rgba(255,255,255,0.4); } 100% { box-shadow: 0 0 15px rgba(255,255,255,1); } }

        .vip-1-text-breath { animation: vip-text-pulse 1.8s infinite alternate ease-in-out; font-weight: 900 !important; }
        @keyframes vip-text-pulse {
            0% { text-shadow: 0 0 4px rgba(255,255,255,0.2); filter: brightness(1); }
            100% { text-shadow: 0 0 8px #fff, 0 0 15px var(--mac-blue), 0 0 25px var(--mac-blue); filter: brightness(1.3); }
        }

        .marquee-wrapper { overflow: hidden; white-space: nowrap; position: relative; width: 100%; display: flex; justify-content: center; }
        .marquee-active { animation: marquee 15s linear infinite; display: inline-block; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .master-sticky-col { position: sticky; left: 0; z-index: 30; background: #121214; min-width: 75px; border-right: 1.5px solid rgba(255,255,255,0.15); }
        .unlock-glow-container { position: relative; width: 340px; height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 60; }
        .core-pulse { animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { transform: scale(0.95); opacity: 0.5; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(0.95); opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, memo, useCallback } = React;

        const FIREBASE_CONFIG = { apiKey: "AIzaSyAx2aYlfqHBUe3V7a3sT5ZPVNYyr2JY8OA", authDomain: "tpac-schedule.firebaseapp.com", projectId: "tpac-schedule", storageBucket: "tpac-schedule.firebasestorage.app", messagingSenderId: "70955835780", appId: "1:70955835780:web:9d3b0958738557d1f7fdd1" };
        const STAFF_ORDER = ["王志剛", "張國飛", "張劭如", "謝祥玄", "張懷德", "楊淯舒", "黎祐甄", "廖俊龍", "曾健洋", "劉智敏"];
        const STAFF_INFO = { 
            "廖俊龍": { type: "Normal", gender: "M", vipTag: "VIP1" }, 
            "張劭如": { type: "Normal", gender: "F" }, 
            "楊淯舒": { type: "Normal", gender: "F" }, "黎祐甄": { type: "Normal", gender: "F" }, 
            "劉智敏": { type: "Special", gender: "M" }, 
            "曾健洋": { type: "Special", gender: "M" }, 
            "王志剛": { type: "Normal", gender: "M" }, "張國飛": { type: "Normal", gender: "M" }, 
            "張懷德": { type: "Normal", gender: "M" }, "謝祥玄": { type: "Normal", gender: "M" } 
        };

        const formatK = (d) => `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
        const getMonK = (s) => { const d = new Date(s), day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); return formatK(new Date(d.setDate(diff))); };

        const Icon = memo(({ name, className = "w-4 h-4" }) => {
            const icons = {
                refresh: <React.Fragment><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /><path d="M16 21h5v-5" /></React.Fragment>,
                check: <path d="M20 6 9 17l-5-5" />,
                cloud: <path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.2-1.6-4-3.7-4.4-.5-3.1-3.2-5.6-6.3-5.6-2.5 0-4.7 1.5-5.7 3.6-2 .4-3.3 2.1-3.3 4.1C3 15.2 5.2 18 8 18h9.5z" />,
                info: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></React.Fragment>,
                sun: <path d="M12 2v2m0 16v2m10-10h-2M4 12H2m15.364-7.364l-1.414 1.414M7.05 16.95l-1.414 1.414M16.95 16.95l1.414 1.414M5.636 5.636l1.414 1.414M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z" />,
                briefcase: <React.Fragment><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></React.Fragment>,
                copy: <path d="M8 4v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7.242a2 2 0 0 0-.602-1.43L16.083 2.57A2 2 0 0 0 14.685 2H10a2 2 0 0 0-2 2z M16 2v4h4 M4 8H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1"/>,
                chevronLeft: <path d="m15 18-6-6 6-6" />,
                chevronRight: <path d="m9 18 6-6-6-6" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || icons.cloud}</svg>;
        });

        const StaffButton = memo(({ name, aliasMap = {}, forceName = null, onClick, mode = "normal", isBShift = false, showGlow = false }) => {
            const info = STAFF_INFO[name] || { gender: 'M' };
            const disp = forceName || aliasMap[name] || name;
            const isALong = name === "廖俊龍";
            const vipClass = info.vipTag === "VIP1" ? "vip-1-text-breath" : "";
            const colorClass = info?.type === "Special" ? "text-[var(--special-text)]" : info?.gender === "F" ? "text-[var(--women-text)]" : "text-[var(--men-text)]";
            const weight = "font-normal";
            const dotClass = info?.type === "Special" ? "bg-[var(--special-dot)]" : info?.gender === "F" ? "bg-[var(--women-dot)]" : "bg-[var(--men-dot)]";
            const fontSize = mode === "tiny" ? "text-[14px]" : (mode === "small" ? (isALong ? "text-[14px]" : "text-[18px]") : (mode === "master" ? "text-[16px]" : (isALong ? "text-[22px]" : "text-[26px]")));
            const btnClass = `${mode === "small" || mode === "master" ? 'h-8' : 'h-10'} ${fontSize} rounded-[0.6rem] ${(isBShift && showGlow) ? 'b-shift-glow' : ''}`;
            const handleClick = (e) => { e.stopPropagation(); if(onClick) onClick(name); };

            return (
                <button onClick={handleClick} className={`w-full ${btnClass} ${vipClass} ${weight} tracking-tight border border-white/5 bg-white/[0.06] flex items-center justify-center gap-1 shadow-sm ${colorClass} leading-none truncate shrink-0 active:scale-95 transition-transform`} title={disp}>
                    <span className={`w-1 h-1 rounded-full ${dotClass} shadow-[0_0_5px_currentColor]`}></span>{disp}
                </button>
            );
        });

        const App = () => {
            const [dates, setDates] = useState([]), [schedule, setSchedule] = useState({ roster: {}, statuses: {}, shows: {}, notes: {}, updated: null });
            const [dateIdx, setDateIdx] = useState(0), [weekOffset, setWeekOffset] = useState(0);
            const [isUnlocked, setIsUnlocked] = useState(false), [user, setUser] = useState(null);
            const [aliasMap, setAlias
